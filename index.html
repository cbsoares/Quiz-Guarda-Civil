<!-- Index.html ‚Äî Vers√£o completa (Op√ß√£o A) -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Quiz Guarda Civil ‚Äî Plataforma (Pago √∫nico)</title>
  <meta name="theme-color" content="#1e3c72"/>
  <style>
    :root{
      --bg1:#0f3b6b; --bg2:#1f6fb0;
      --card-bg: rgba(255,255,255,0.06); --muted: rgba(255,255,255,0.92);
      --accent: #00ff9d;
      --card-scale: 1.10;
      --success:#00c46a; --danger:#ff5c6c;
    }
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      color:#fff; display:flex; align-items:center; justify-content:center;
      padding:env(safe-area-inset-top) 12px calc(env(safe-area-inset-bottom) + 12px) 12px;
    }
    .app { width:100%; max-width:980px; display:flex; flex-direction:column; gap:12px; }
    .card { background: var(--card-bg); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.28); backdrop-filter: blur(6px); transform: scale(var(--card-scale)); transform-origin: top center; transition: transform .12s ease; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .title { font-size: clamp(18px,4vw,24px); margin:0; }
    .subtitle { font-size:13px; color:#e6f7f0; margin-top:6px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .btn { background:transparent;border:1px solid rgba(255,255,255,0.12); color:#fff;padding:8px 10px;border-radius:10px;font-weight:700; cursor:pointer; }
    .primary { background: linear-gradient(90deg,var(--accent), #2fb6ff); color:#012; border:none; }
    .small { font-size:13px; color:#dfeff5; }
    .pages { min-height:360px; }
    .page { display:none; }
    .page.active { display:block; animation: fadeIn .18s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
    .welcome { font-size:18px; margin:6px 0 12px 0; color:var(--muted); }
    .tabs { display:flex; justify-content:space-around; gap:6px; margin-top:8px; }
    .tabbtn { flex:1; padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;font-weight:800;cursor:pointer;text-align:center; }
    .tabbtn.active{ background: rgba(255,255,255,0.06); }
    .grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); }
    .card-small { padding:12px; border-radius:12px; background:rgba(255,255,255,0.03); }
    .flashcard { perspective:1000px; cursor:pointer; }
    .flash-inner { transition: transform .5s; transform-style: preserve-3d; position:relative; min-height:120px; }
    .flash-front, .flash-back { backface-visibility: hidden; position:absolute; inset:0; border-radius:10px; padding:14px; display:flex; flex-direction:column; justify-content:center; }
    .flash-front { background:rgba(255,255,255,0.02); color:#fff; }
    .flash-back { transform: rotateY(180deg); background:rgba(0,0,0,0.12); color:#fff; }
    .flash-inner.flipped { transform: rotateY(180deg); }
    .opts { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    button.opt { padding:12px; min-height:62px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background:#fff; color:#123; font-weight:800; cursor:pointer; text-align:left; }
    .explain { margin-top:12px; padding:12px; background:rgba(255,255,255,0.04); border-radius:10px; color:#fff; }
    .small-muted { font-size:12px; color:#cfeee3; }
    .notice { padding:8px 10px; border-radius:8px; }
    .notice.ok { background: rgba(0,196,106,0.12); color:var(--success); border:1px solid rgba(0,196,106,0.12); }
    .notice.err { background: rgba(255,92,108,0.08); color:var(--danger); border:1px solid rgba(255,92,108,0.08); }

    /* responsive */
    @media (max-width:520px){
      .opts{ grid-template-columns:1fr; }
      .controls{flex-wrap:wrap}
      .title{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="app" id="appRoot">

    <!-- HEADER -->
    <div class="card header" id="cardHeader">
      <div>
        <h1 class="title">Guarda Civil ‚Äî Plataforma (Pagamento √önico)</h1>
        <div class="subtitle">Simulados ‚Ä¢ Flashcards ‚Ä¢ Quiz ‚Ä¢ Resultados</div>
      </div>
      <div class="controls">
        <div id="userBadge" class="small-muted">Acesso: <strong id="accessLabel">‚Äî</strong></div>
        <button class="btn" id="btnOpenLogin">Entrar / Resgatar</button>
      </div>
    </div>

    <!-- PAGES -->
    <div class="card pages" id="pages">

      <!-- HOME -->
      <section id="home" class="page active">
        <div class="welcome">Bem-vindo! Escolha um modo para estudar ‚Äî flashcards, quiz ou simulados.</div>
        <div class="grid">
          <div class="card-small">
            <h4>Estudo R√°pido</h4>
            <p class="small-muted">Flashcards por assunto ‚Äî clique para virar.</p>
            <div style="margin-top:8px">
              <button class="btn primary" onclick="go('cards')">Ir para Cart√µes</button>
            </div>
          </div>
          <div class="card-small">
            <h4>Quiz por t√≥pico</h4>
            <p class="small-muted">Treine quest√µes selecionadas por t√≥pico.</p>
            <div style="margin-top:8px">
              <button class="btn primary" onclick="go('quiz')">Fazer Quiz</button>
            </div>
          </div>
          <div class="card-small">
            <h4>Simulados</h4>
            <p class="small-muted">Modo prova ‚Äî salve e acompanhe performance.</p>
            <div style="margin-top:8px">
              <button class="btn primary" onclick="showSimuladoSetup()">Iniciar Simulado</button>
            </div>
          </div>
          <div class="card-small">
            <h4>Hist√≥rico</h4>
            <p class="small-muted">Seus simulados salvos e desempenho.</p>
            <div style="margin-top:8px">
              <button class="btn" onclick="go('history')">Ver Hist√≥rico</button>
            </div>
          </div>
        </div>
      </section>

      <!-- STUDY / FLASHCARDS (cards) -->
      <section id="cards" class="page">
        <h3>Cart√µes ‚Äî clique para virar</h3>
        <div id="cardsContainer" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px;"></div>
      </section>

      <!-- QUIZ -->
      <section id="quiz" class="page">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label class="small" style="font-weight:800">T√≥pico:</label>
          <select id="topicSelect"></select>
          <button class="btn" id="loadTopicBtn">Carregar</button>
          <div style="flex:1"></div>
          <div class="small" id="quizNote">Quest√µes por rodada: <strong id="quizSizeLabel"></strong></div>
        </div>

        <div style="margin-top:10px" class="progress-area">
          <div id="question" class="small-muted" style="white-space:pre-wrap;margin-top:12px">Aguardando escolha do t√≥pico...</div>
          <div id="opts" class="opts" style="margin-top:10px"></div>
        </div>

        <div class="explain" id="explain" style="display:none"></div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" id="btnRestart" onclick="restartQuiz()" style="display:none">üîÑ Reiniciar</button>
          <button class="btn primary" id="nextBtn" disabled>Pr√≥xima ‚ûú</button>
        </div>
      </section>

      <!-- SIMULADOS (usa m√≥dulo) -->
      <section id="sim" class="page">
        <h3>Simulados</h3>
        <div id="simArea"></div>
        <div id="simTimerArea" style="margin-top:8px"></div>
      </section>

      <!-- HISTORY -->
      <section id="history" class="page">
        <h3>Hist√≥rico</h3>
        <div id="historyList"></div>
      </section>

    </div>

    <!-- TABS -->
    <div class="tabs card" role="navigation" aria-label="Navega√ß√£o">
      <button class="tabbtn active" data-target="home" onclick="go('home')">In√≠cio</button>
      <button class="tabbtn" data-target="cards" onclick="go('cards')">Cart√µes</button>
      <button class="tabbtn" data-target="quiz" onclick="go('quiz')">Quiz</button>
      <button class="tabbtn" data-target="sim" onclick="go('sim')">Simulados</button>
      <button class="tabbtn" data-target="history" onclick="go('history')">Hist√≥rico</button>
    </div>

  </div>

  <!-- LOGIN / REDEEM MODAL (simples) -->
  <div id="loginModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:40">
    <div class="card" style="width:92%;max-width:480px">
      <h3>Entrar / Resgatar compra</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <input id="inputEmail" placeholder="Seu e-mail (opcional)" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)"/>
        <input id="inputCode" placeholder="C√≥digo de compra (PIX / Voucher)" style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)"/>
        <div style="display:flex;gap:8px">
          <button class="btn primary" id="btnRedeem">Resgatar</button>
          <button class="btn" id="btnDemo">Demo</button>
          <button class="btn" id="btnCloseLogin">Fechar</button>
        </div>
        <div id="redeemNotice" style="margin-top:6px"></div>
        <div class="small-muted" style="margin-top:6px">Se j√° comprou via pagamento, insira o c√≥digo que enviamos por e-mail. Se quiser testar, use Demo (acesso limitado).</div>
      </div>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLiD4IhDoMK49_W-IlRUnPgl3CnTvyC_08Ks097o6jSX1qvDl6HP7tyRZsyj4Io8xVUA/exec';
const TEMPLATE_QUIZ_SIZE = 20;

/* ===================== STATE ===================== */
let USER = { email: null, hasAccess: false };
let POOL = []; let currentIndex = 0; let score = 0; let quizStarted = false;

/* ===================== Helpers ===================== */
function q_text(q){ if(!q) return ''; return q.pergunta || q.question || q.Pergunta || ''; }
function q_topic(q){ if(!q) return ''; return q.materia || q.topico || q.t√≥pico || q.topic || ''; }
function q_expl(q){ if(!q) return ''; return q.explicacao || q.explanation || q.resposta || q.answer || ''; }
function q_answer_letter(q){ const a = (q.resposta || q.answer || q.answer || '').toString().trim(); if (!a) return ''; return a.substr(0,1).toUpperCase(); }
function q_option(q, letter){ const up = q[letter.toUpperCase()]; if (up !== undefined && up !== null && up !== '') return up; const low = q[letter.toLowerCase()]; if (low !== undefined && low !== null && low !== '') return low; return ''; }
function linkify(text){ if(!text) return ''; let out = text.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); out = out.replace(/\n/g,'<br>'); return out; }

/* ===================== Navigation ===================== */
function go(target){
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(target).classList.add('active');
  document.querySelectorAll('.tabbtn').forEach(b => b.classList.toggle('active', b.dataset.target === target));
  if (target === 'cards') renderCards();
  if (target === 'quiz') showTopicSelection();
  if (target === 'history') renderHistory();
}

/* ===================== Login / Redeem ===================== */
document.getElementById('btnOpenLogin').addEventListener('click', ()=> openLogin());
document.getElementById('btnCloseLogin').addEventListener('click', ()=> closeLogin());
document.getElementById('btnDemo').addEventListener('click', ()=> { setDemoAccess(); closeLogin(); });
document.getElementById('btnRedeem').addEventListener('click', ()=> { const code = document.getElementById('inputCode').value.trim(); const email = document.getElementById('inputEmail').value.trim(); redeemCode(code,email); });

function openLogin(){ document.getElementById('inputCode').value=''; document.getElementById('inputEmail').value=''; document.getElementById('redeemNotice').innerHTML=''; document.getElementById('loginModal').style.display='flex'; }
function closeLogin(){ document.getElementById('loginModal').style.display='none'; }

function setDemoAccess(){
  USER.hasAccess = true;
  localStorage.setItem('gcm_access','DEMO');
  updateAccessLabel();
  alert('Acesso DEMO ativado (limitado).');
}

/* Redeem: tenta ler aba "Clientes" e verificar c√≥digo.
   A fun√ß√£o aceita c√≥digo simples; ela busca no sheet "Clientes" (se existir)
   e verifica se algum campo bate com o c√≥digo. Se encontrado, marca acesso. */
async function redeemCode(code,email){
  if (!code) { document.getElementById('redeemNotice').innerHTML = '<div class="notice err">Informe o c√≥digo de compra.</div>'; return; }
  document.getElementById('redeemNotice').innerHTML = '<div class="notice">Validando...</div>';
  try {
    const url = `${SCRIPT_URL}?action=getSheetByName&sheet=Clientes`;
    const res = await fetch(url, {cache:'no-store'});
    const js = await res.json();
    console.log('redeem getSheetByName:', js);
    if (js && js.ok && js.sheet && Array.isArray(js.sheet.rows) && js.sheet.rows.length){
      // procura o c√≥digo em qualquer c√©lula das rows
      const rows = js.sheet.rows;
      let found = false;
      for (const r of rows){
        for (const c of r){
          if (!c) continue;
          if (String(c).trim() === code) { found = true; break; }
        }
        if (found) break;
      }
      if (found){
        USER.hasAccess = true;
        if (email) USER.email = email;
        localStorage.setItem('gcm_access', code);
        if (email) localStorage.setItem('gcm_email', email);
        document.getElementById('redeemNotice').innerHTML = '<div class="notice ok">C√≥digo v√°lido! Acesso liberado.</div>';
        updateAccessLabel();
        setTimeout(()=> closeLogin(),900);
        return;
      } else {
        document.getElementById('redeemNotice').innerHTML = '<div class="notice err">C√≥digo n√£o encontrado. Verifique a ortografia.</div>';
        return;
      }
    } else {
      document.getElementById('redeemNotice').innerHTML = '<div class="notice err">Planilha "Clientes" n√£o encontrada ou vazia.</div>';
      console.warn('Sheet Clientes n√£o encontrada', js);
    }
  } catch(e){
    console.error('redeemCode err', e);
    document.getElementById('redeemNotice').innerHTML = '<div class="notice err">Erro ao verificar c√≥digo (ver console).</div>';
  }
}

/* Atualiza badge de acesso */
function updateAccessLabel(){
  const lbl = document.getElementById('accessLabel');
  const v = localStorage.getItem('gcm_access');
  const email = localStorage.getItem('gcm_email');
  if (v) { lbl.innerText = (v==='DEMO' ? 'Demo' : 'Pago'); if (email) lbl.innerText += ' ‚Äî ' + email; USER.hasAccess = true; USER.email = email || null; } else { lbl.innerText = 'Sem acesso'; USER.hasAccess = false; }
}
updateAccessLabel();

/* ===================== Flashcards (cards) ===================== */
async function renderCards(){
  const container = document.getElementById('cardsContainer');
  container.innerHTML = '<div class="small-muted">Carregando cart√µes...</div>';
  try {
    const sheetName = 'cart√µes';
    const res = await fetch(`${SCRIPT_URL}?action=getCards&sheet=${encodeURIComponent(sheetName)}`, {cache:'no-store'});
    const js = await res.json();
    console.log('getCards:', js);
    let list = [];
    if (js && js.ok && Array.isArray(js.cards)) list = js.cards;
    else if (js && Array.isArray(js)) list = js;
    else if (js && js.ok && js.questions) list = js.questions;
    if (!list || !list.length){
      container.innerHTML = '<div class="small-muted">Nenhum cart√£o encontrado na aba "cart√µes".</div>';
      return;
    }
    // render
    container.innerHTML = '';
    for (const q of list){
      const frontText = (q.pergunta || q.question || '').toString();
      const topicText = (q.topico || q.materia || '').toString();
      const backText = (q.resposta || q.explanation || q.explicacao || '').toString();
      const wrapper = document.createElement('div'); wrapper.className='flashcard card-small';
      const inner = document.createElement('div'); inner.className='flash-inner';
      const front = document.createElement('div'); front.className='flash-front';
      const back = document.createElement('div'); back.className='flash-back';
      front.innerHTML = `<div style="font-size:12px;color:#dfeff5">${topicText}</div><div style="font-weight:800;margin-top:8px">${frontText}</div><div style="margin-top:8px;font-size:13px;color:#bfeadf">Clique para virar</div>`;
      back.innerHTML = `<div style="font-size:12px;color:#dfeff5">${topicText}</div><div style="font-weight:800;margin-top:8px">${backText}</div>`;
      inner.appendChild(front); inner.appendChild(back); wrapper.appendChild(inner);
      wrapper.addEventListener('click', ()=> inner.classList.toggle('flipped'));
      container.appendChild(wrapper);
    }
  } catch(e){
    console.error('renderCards err', e);
    container.innerHTML = '<div class="small-muted">Erro ao carregar cart√µes. Veja console.</div>';
  }
}

/* ===================== QUIZ ===================== */
const topicSelect = document.getElementById('topicSelect');
document.getElementById('loadTopicBtn').addEventListener('click', ()=> loadTopicQuestions(topicSelect.value));
document.getElementById('nextBtn').addEventListener('click', ()=> { if (!quizStarted) return; currentIndex++; renderQuestion(); });

async function showTopicSelection(){
  topicSelect.innerHTML = '';
  const opt = document.createElement('option'); opt.value='Todos'; opt.textContent='Todos'; topicSelect.appendChild(opt);
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getTopics`, {cache:'no-store'});
    const js = await res.json();
    if (js && js.ok && js.topics) js.topics.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; topicSelect.appendChild(o); });
  } catch(e){ console.warn('showTopicSelection err', e); }
}
showTopicSelection();

async function loadTopicQuestions(topic){
  document.getElementById('question').innerText = 'Carregando perguntas...';
  try {
    const encoded = encodeURIComponent(topic || 'Todos');
    const res = await fetch(`${SCRIPT_URL}?action=getQuestionsByTopic&topic=${encoded}`, {cache:'no-store'});
    const js = await res.json();
    let data = (js && js.ok && js.questions) ? js.questions.slice() : [];
    if (!data || !data.length) {
      // tentativa getAllQuestions
      const r2 = await fetch(`${SCRIPT_URL}?action=getAllQuestions`, {cache:'no-store'});
      const j2 = await r2.json();
      data = (j2 && j2.ok && j2.questions) ? j2.questions.slice() : [];
    }
    POOL = data.slice(0, TEMPLATE_QUIZ_SIZE || 20);
    currentIndex = 0; score = 0; quizStarted = true;
    document.getElementById('btnRestart').style.display = 'none';
    renderQuestion();
  } catch (err){
    console.error('Erro ao carregar quest√µes:', err);
    document.getElementById('question').innerText = 'Erro ao carregar quest√µes.';
  }
}

function renderQuestion(){
  document.getElementById('explain').style.display='none';
  document.getElementById('nextBtn').disabled = true;
  if (!POOL || POOL.length === 0) {
    document.getElementById('question').innerText = 'Nenhuma quest√£o dispon√≠vel.';
    document.getElementById('opts').innerHTML = '';
    quizStarted = false;
    return;
  }
  if (currentIndex >= POOL.length) { finishQuiz(); return; }
  const q = POOL[currentIndex];
  document.getElementById('question').innerText = `üìò ${q_topic(q) || ''}\n${q_text(q)}`;
  const optsDiv = document.getElementById('opts'); optsDiv.innerHTML = '';
  ['A','B','C','D'].forEach(letter=>{
    const txt = q_option(q, letter);
    if (!txt) return;
    const btn = document.createElement('button'); btn.className='opt'; btn.innerText = `${letter}) ${txt}`;
    btn.onclick = ()=> selectOption(letter);
    optsDiv.appendChild(btn);
  });
  updateProgressUI();
}

function selectOption(letter){
  if (!quizStarted) return;
  const q = POOL[currentIndex];
  const correct = q_answer_letter(q);
  const chosen = letter.toUpperCase();
  document.querySelectorAll('.opt').forEach(el => el.disabled = true);
  const elChosen = Array.from(document.querySelectorAll('.opt')).find(b => b.innerText.startsWith(chosen + ')'));
  if (elChosen){
    if (chosen === correct) { elChosen.style.borderColor = 'var(--success)'; score++; }
    else { elChosen.style.borderColor = 'var(--danger)'; }
  }
  const title = (chosen === correct) ? '‚úÖ Correto!' : ('‚ùå Errado! Resposta: ' + (correct || '‚Äî'));
  document.getElementById('explain').style.display='block';
  document.getElementById('explain').innerHTML = `<strong>${title}</strong><div style="margin-top:8px;color:#dfeff5">${q_expl(q) || ''}</div>`;
  document.getElementById('nextBtn').disabled = false;
}

function updateProgressUI(){
  const total = POOL.length || 0;
  document.getElementById('quizSizeLabel').innerText = total;
  document.getElementById('progressInfo')?.innerText = `${currentIndex + 1} / ${total}`;
}

function finishQuiz(){
  quizStarted = false;
  const total = POOL.length || 1;
  const pct = Math.round((score / total) * 100);
  document.getElementById('question').innerText = `‚úî Voc√™ acertou ${score} de ${total} (${pct}%)`;
  document.getElementById('opts').innerHTML = '';
  document.getElementById('explain').style.display='block';
  document.getElementById('explain').innerHTML = `<div style="color:#dfeff5">Salve seu resultado no hist√≥rico se quiser.</div><div style="margin-top:8px"><button class="btn" onclick="saveLocalResult({score:${score},total:${total},pct:${pct},mode:'quiz'})">Salvar no hist√≥rico</button></div>`;
  document.getElementById('btnRestart').style.display = 'inline-block';
}

/* ===================== Simulados (m√≥dulo) ===================== */
let SIM = { pool:[], idx:0, answers:[], timer:null, timeLeft:0, config:null };

async function showSimuladoSetup(){
  go('sim');
  const html = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <label class="small">T√≥pico:</label>
      <select id="simTopic"></select>
      <label class="small"># Quest√µes:</label>
      <select id="simSize"><option>20</option><option>30</option><option>50</option></select>
      <label class="small"><input type="checkbox" id="simTimed"> Cronometrado</label>
      <button class="btn primary" id="startSimBtn">Iniciar Simulado</button>
    </div>
  `;
  document.getElementById('simArea').innerHTML = html;
  // populate topics
  const sel = document.getElementById('simTopic');
  sel.innerHTML = '<option>Todos</option>';
  try {
    const res = await fetch(`${SCRIPT_URL}?action=getTopics`, {cache:'no-store'});
    const js = await res.json();
    if (js && js.ok && js.topics) js.topics.forEach(t => { const o = document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
  } catch(e){ console.warn('sim topics', e); }
  document.getElementById('startSimBtn').addEventListener('click', ()=> {
    const topic = document.getElementById('simTopic').value;
    const size = parseInt(document.getElementById('simSize').value,10);
    const timed = document.getElementById('simTimed').checked;
    startSimulado({topic,size,timed});
  });
}

async function startSimulado(cfg){
  SIM = { pool:[], idx:0, answers:[], timer:null, timeLeft:0, config:cfg };
  try {
    const url = (cfg.topic && cfg.topic !== 'Todos') ? `${SCRIPT_URL}?action=getQuestionsByTopic&topic=${encodeURIComponent(cfg.topic)}` : `${SCRIPT_URL}?action=getAllQuestions`;
    const res = await fetch(url, {cache:'no-store'});
    const js = await res.json();
    let list = (js && js.ok && js.questions) ? js.questions : (Array.isArray(js) ? js : []);
    // shuffle
    for (let i=list.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [list[i],list[j]]=[list[j],list[i]]; }
    SIM.pool = list.slice(0, Math.min(cfg.size || 20, list.length));
    SIM.answers = Array(SIM.pool.length).fill(null);
    SIM.idx = 0;
    if (cfg.timed) { SIM.timeLeft = SIM.pool.length * 60; startSimTimer(); }
    renderSimuladoQuestion();
  } catch(e){ console.error('startSimulado err', e); document.getElementById('simArea').innerText = 'Erro ao iniciar simulado.'; }
}

function startSimTimer(){
  if (SIM.timer) clearInterval(SIM.timer);
  SIM.timer = setInterval(()=> {
    SIM.timeLeft--;
    const m = Math.floor(SIM.timeLeft/60); const s = SIM.timeLeft%60;
    document.getElementById('simTimerArea').innerText = `Tempo restante: ${m}:${String(s).padStart(2,'0')}`;
    if (SIM.timeLeft <= 0) { clearInterval(SIM.timer); finishSimulado(); }
  },1000);
}

function renderSimuladoQuestion(){
  const q = SIM.pool[SIM.idx];
  if (!q) { finishSimulado(); return; }
  document.getElementById('simArea').innerHTML = `<div style="white-space:pre-wrap">${q_text(q)}</div>`;
  const opts = document.getElementById('opts'); opts.innerHTML = '';
  ['A','B','C','D'].forEach(letter=>{
    const txt = q_option(q,letter);
    if (!txt) return;
    const b = document.createElement('button'); b.className='opt'; b.innerText = `${letter}) ${txt}`;
    b.onclick = ()=> {
      SIM.answers[SIM.idx] = letter;
      Array.from(opts.querySelectorAll('button.opt')).forEach(bt=> bt.style.opacity=0.6);
      b.style.opacity = 1;
      setTimeout(()=> { if (SIM.idx < SIM.pool.length-1) { SIM.idx++; renderSimuladoQuestion(); } else finishSimulado(); }, 250);
    };
    opts.appendChild(b);
  });
}

function finishSimulado(){
  if (SIM.timer) { clearInterval(SIM.timer); SIM.timer = null; }
  const total = SIM.pool.length; let sc = 0; const details = [];
  for (let i=0;i<total;i++){
    const q = SIM.pool[i]; const chosen = SIM.answers[i]; const correct = (q.answer || q.resposta || '').toString().substr(0,1).toUpperCase();
    const ok = chosen && chosen.toUpperCase() === correct;
    if (ok) sc++;
    details.push({id:q.id||i+1,question:q_text(q),chosen:chosen||null,correct:correct||null,ok});
  }
  const pct = Math.round((sc/total)*100);
  document.getElementById('simArea').innerHTML = `<div>Resultado: ${sc}/${total} (${pct}%)</div><div style="margin-top:8px"><button class="btn primary" onclick="saveSimuladoResult({score:${sc},total:${total},pct:${pct},details:JSON.stringify(details),topic:'${SIM.config.topic}',timed:${SIM.config.timed},date:new Date().toISOString()})">Salvar resultado</button> <button class="btn" onclick="reviewSimulado(${JSON.stringify(JSON.stringify(details))})">Rever erros</button></div>`;
  saveLocalResult({score:sc,total:total,pct:pct,mode:'simulado',date:new Date().toISOString(),topic:SIM.config.topic});
}

function reviewSimulado(jsonStr){
  try {
    const details = JSON.parse(JSON.parse(jsonStr));
    const wrong = details.filter(d=>!d.ok);
    if (!wrong.length) { alert('Nenhum erro :-)'); return; }
    SIM.pool = wrong.map(w=> ({question:w.question, id:w.id}) );
    SIM.idx = 0; renderSimuladoQuestion();
    go('sim');
  } catch(e){ console.error(e); alert('Erro ao revisar.'); }
}

/* Save simulado result to backend (doPost) */
async function saveSimuladoResult(payload){
  try {
    // backend espera JSON no body e retorna {ok:true}
    const res = await fetch(`${SCRIPT_URL}?action=saveSimuladoResult`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: typeof payload === 'string' ? payload : JSON.stringify(payload)
    });
    const js = await res.json();
    console.log('saveSimuladoResult response', js);
    if (js && js.ok) {
      alert('Resultado salvo no servidor (linha: ' + (js.id || '‚Äî') + ').');
    } else {
      alert('N√£o foi poss√≠vel salvar no servidor. Resultado salvo localmente.');
    }
  } catch(e){
    console.error('saveSimuladoResult err', e);
    alert('Erro ao salvar resultado (ver console).');
  }
}

/* ===================== Local History ===================== */
function saveLocalResult(obj){
  const key = 'gcm_history_v1';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  arr.unshift(obj);
  localStorage.setItem(key, JSON.stringify(arr.slice(0,200)));
  alert('Resultado salvo localmente.');
  renderHistory();
}

function renderHistory(){
  const key = 'gcm_history_v1';
  const arr = JSON.parse(localStorage.getItem(key) || '[]');
  const container = document.getElementById('historyList');
  if (!arr || !arr.length) { container.innerHTML = '<div class="small-muted">Nenhum hist√≥rico salvo.</div>'; return; }
  container.innerHTML = '';
  arr.forEach((r,i)=>{
    const div = document.createElement('div'); div.className='card-small'; div.style.marginBottom='8px';
    div.innerHTML = `<div><strong>${r.mode || 'simulado'}</strong> ‚Äî ${r.score}/${r.total} (${r.pct}%) <span style="float:right;font-size:12px;color:#dfeff5">${r.date? new Date(r.date).toLocaleString():''}</span></div><div class="small-muted" style="margin-top:6px">${r.topic? 'T√≥pico: '+r.topic : ''}</div>`;
    container.appendChild(div);
  });
}

/* ===================== Inicializa√ß√£o ===================== */
(function init(){
  // label access
  updateAccessLabel();
  // set quiz size label
  document.getElementById('quizSizeLabel').innerText = TEMPLATE_QUIZ_SIZE || 20;
  // wire login open
  // show home
  go('home');
  // auto-render cards on load for speed
  // don't call heavy endpoints until requested
  window.addEventListener('error', (e)=> console.error('window error', e));
})();
</script>
</body>
</html>
