<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Quiz Guarda Civil ‚Äî App</title>
  <meta name="theme-color" content="#1e3c72"/>
  <style>
    :root{ --bg1:#0f3b6b; --bg2:#1f6fb0; --card-bg: rgba(255,255,255,0.06); --muted: rgba(255,255,255,0.92); --accent: #00ff9d; --card-scale: 1.10; }
    html,body{height:100%;margin:0;padding:0}
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; display:flex; align-items:center; justify-content:center; padding:env(safe-area-inset-top) 12px calc(env(safe-area-inset-bottom) + 12px) 12px; }
    .app { width:100%; max-width:920px; display:flex; flex-direction:column; gap:12px; }
    .card { background: var(--card-bg); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.28); backdrop-filter: blur(6px); transform: scale(var(--card-scale)); transform-origin: top center; transition: transform .12s ease; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .header > div:first-child { flex: 1 1 auto; min-width: 0; }
    .controls { flex: 0 0 auto; display:flex; gap:8px; align-items:center; }
    .title { font-size: clamp(18px,4vw,22px); margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; }
    .subtitle { font-size:13px; color:#e6f7f0; margin-top:6px; }
    .btn { background:transparent;border:1px solid rgba(255,255,255,0.12); color:#fff;padding:8px 10px;border-radius:10px;font-weight:700; cursor:pointer; }
    .icon-btn { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:#fff; cursor:pointer; }
    .scale-label { min-width:62px; text-align:center; font-weight:800; }

    /* ADICIONEI padding-bottom para garantir que conte√∫do n√£o seja coberto pela barra de abas */
    .pages { min-height:340px; padding-bottom: 72px; }

    .page { display:none; }
    .page.active { display:block; animation: fadeIn .22s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
    .welcome { font-size:18px; margin:6px 0 12px 0; color:var(--muted); }
    .home-actions { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
    .study-list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    details.summary { background: rgba(255,255,255,0.03); padding:10px; border-radius:10px; color:#fff; }
    summary { font-weight:800; cursor:pointer; padding:8px 6px; outline:none; }
    .progress { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .track { flex:1; height:12px; background:rgba(255,255,255,0.10); border-radius:999px; overflow:hidden; }
    .bar { height:12px; width:0; background: linear-gradient(90deg, rgba(0,255,157,0.95), rgba(0,214,138,0.95)); transition: width .45s ease; border-radius:999px; }
    .question { margin:12px 0; font-size:18px; color:var(--muted); transition:opacity .2s, transform .2s; white-space:pre-wrap; }
    .opts { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    button.opt { padding:14px; min-height:62px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background:#fff; color:#123; font-weight:800; cursor:pointer; text-align:left; }
    button.opt[disabled]{ opacity:.8; cursor:not-allowed; }
    .opt.correct{ background:#e9fff2; border-color:#2fa764; }
    .opt.wrong{ background:#fff0f0; border-color:#ff6b6b; }
    .explain { margin-top:12px; padding:12px; background:rgba(255,255,255,0.04); border-radius:10px; color:#fff; }
    .final { text-align:center; padding:12px; }
    .record { margin-top:8px; font-size:14px; color:#e6f7f0; }

    /* leve deslocamento pra baixo da barra de abas + z-index pra ficar acima do conte√∫do */
    .tabs { display:flex; justify-content:space-around; gap:6px; margin-top:16px; margin-bottom: calc(env(safe-area-inset-bottom) + 8px); position: relative; z-index: 20; }
    .tabbtn { flex:1; padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;font-weight:800;cursor:pointer;text-align:center; }
    .tabbtn.active{ background: rgba(255,255,255,0.06); }
    .small { font-size:13px; color:#dfeff5; }
    .topic-select { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .next-area { display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:10px; flex-wrap:wrap; }
    .next-btn { background: linear-gradient(90deg,var(--accent), #2fb6ff); border:none; color:#012; font-weight:900; padding:12px 16px; border-radius:12px; cursor:pointer; font-size:16px; }
    .next-btn:disabled { opacity:0.6; cursor:not-allowed; }
    .next-btn.small-btn { padding: 8px 12px; font-size: 14px; border-radius: 10px; }
    .card-small { padding:10px; border-radius:10px; background:rgba(255,255,255,0.03); margin-bottom:8px; }
    .flashcard { perspective:1000px; cursor:pointer; }
    .flash-inner { transition: transform .5s; transform-style: preserve-3d; position:relative; min-height:120px; }
    .flash-front, .flash-back { backface-visibility: hidden; position:absolute; inset:0; border-radius:10px; padding:14px; display:flex; flex-direction:column; justify-content:center; }
    .flash-front { background:rgba(255,255,255,0.02); color:#fff; }
    .flash-back { transform: rotateY(180deg); background:rgba(0,0,0,0.12); color:#fff; }
    .flash-inner.flipped { transform: rotateY(180deg); }

    /* demo banner + overlay */
    .demo-banner { background: rgba(0,0,0,0.2); padding:6px 10px; border-radius:8px; font-weight:800; display:inline-flex; gap:8px; align-items:center; }
    .demo-remaining { font-size:13px; color:#dfffe8; }
    .overlay-lock { position:fixed; inset:0; background:rgba(3,6,12,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .overlay-card { background:#081a2b; padding:20px; border-radius:12px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); max-width:420px; text-align:center; color:#fff; }
    .overlay-card h2{ margin:0 0 8px 0; }
    .overlay-card p{ margin:8px 0 14px 0; color:#d5f5e7 }
    .overlay-card .linkbtn{ display:inline-block; padding:10px 14px; border-radius:10px; background:linear-gradient(90deg,var(--accent), #2fb6ff); color:#012; font-weight:800; text-decoration:none; }

    @media (max-width:520px){
      .header { flex-wrap:wrap; align-items:center; }
      .header > div:first-child { order: 1; flex: 1 1 100%; min-width:0; }
      .controls { order: 2; flex: 1 1 100%; display:flex; justify-content:flex-start; gap:6px; margin-top:8px; }
      .title { white-space:normal; font-size:16px; }
      .controls .icon-btn { width:34px; height:34px; }
      .controls .btn { padding:6px 8px; font-size:13px; }
      .scale-label { min-width:46px; font-size:13px; text-align:center; }
      /* em telas pequenas, d√° um pouquinho mais de folga na parte de baixo */
      .pages { padding-bottom: 92px; }
      .tabs { margin-top:18px; margin-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    }
    @media (max-width:420px){ .title { font-size:15px; } .controls { justify-content:flex-start; gap:6px; } }
    @media (max-width:520px){ .opts{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="app" style="width:100%;max-width:820px;" id="appRoot">

    <!-- HEADER -->
    <div class="card header" id="cardHeader">
      <div>
        <h1 class="title">Quiz Guarda Civil üëÆ‚Äç‚ôÇÔ∏è</h1>
        <div class="subtitle">Estude por t√≥picos </div>
      </div>

      <div class="controls">
        <div id="demoBanner" class="demo-banner" style="display:none">
          <div style="font-size:13px;">DEMO</div>
          <div class="demo-remaining" id="demoRemaining">‚Äî</div>
        </div>
        <button class="icon-btn" id="scaleDownBtn" title="Diminuir caixa">A‚àí</button>
        <div class="scale-label" id="scaleLabel">x1.10</div>
        <button class="icon-btn" id="scaleUpBtn" title="Aumentar caixa">A+</button>
        <button class="icon-btn" id="fullscreenBtn" title="Tela cheia">‚õ∂</button>
        <button class="btn" id="soundToggle">üîä Som: On</button>
        <!-- bot√£o de compra vis√≠vel -->
        <button class="btn" id="buyBtn" title="Adquirir vers√£o paga">üí≥ Comprar</button>
      </div>
    </div>

    <!-- PAGES -->
    <div class="card pages" id="pages">
      <section id="home" class="page active">
        <div class="welcome">Ol√°! Escolha um t√≥pico e inicie o quiz quando estiver pronto.</div>
        <div class="home-actions">
          <button class="btn" onclick="go('study')" id="btnStudy">üìò Estudar</button>
          <button class="btn" onclick="go('quiz')" id="btnQuiz">üéØ Fazer Quiz</button>
          <button class="btn" onclick="go('cards')" id="btnCards">üÉè Cart√µes</button>
        </div>
        <div style="margin-top:12px">
          <div id="bestRecord" class="record">Carregando recorde...</div>
        </div>
      </section>

      <section id="study" class="page">
        <h3>Conte√∫dos de Estudo</h3>
        <div id="studyList" class="study-list"></div>
      </section>

      <section id="quiz" class="page">
        <div class="topic-select">
          <div class="average">Escolha o T√≥pico:</div>
          <select id="topicSelect" class="average"></select>
          <button class="next-btn small-btn" id="loadTopicBtn">Carregar t√≥pico</button>
          <div style="flex:1"></div>
          <div class="small" id="quizNote">Quest√µes por rodada: <strong id="quizSizeLabel"></strong></div>
        </div>

        <div class="progress" style="margin-bottom:8px">
          <div class="track"><div class="bar" id="bar" style="width:0%"></div></div>
          <div class="small" id="progressInfo">0 / 0</div>
        </div>

        <div class="question" id="question">Aguardando escolha do t√≥pico...</div>
        <div class="opts" id="opts"></div>
        <div class="explain" id="explain" style="display:none"></div>

        <div class="next-area">
          <div id="progressText" class="small"></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnRestart" onclick="restartQuiz()" style="display:none">üîÑ Reiniciar</button>
            <button class="next-btn" id="nextBtn" disabled>Pr√≥xima ‚ûú</button>
          </div>
        </div>
      </section>

      <section id="cards" class="page">
        <h3>Cart√µes (clique para virar)</h3>
        <div id="cardsContainer" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px;"></div>
      </section>
    </div>

    <div class="tabs card" role="navigation" aria-label="Navega√ß√£o">
      <button class="tabbtn active" data-target="home" onclick="go('home')">In√≠cio</button>
      <button class="tabbtn" data-target="study" onclick="go('study')">Estudo</button>
      <button class="tabbtn" data-target="quiz" onclick="go('quiz')">Quiz</button>
      <button class="tabbtn" data-target="cards" onclick="go('cards')">Cart√µes</button>
    </div>

  </div>

  <!-- overlay lock inserted dynamically -->

<script>
  /* ===================== CONFIGURE AQUI ===================== */
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwQ1Yv-yAGj51HQDoEd6po-AL0pmKbIDVuwGbOmauXpnxozKt2vWtlDG96e40vZp77GLw/exec';
  const TEMPLATE_QUESTIONS = null;
  const TEMPLATE_STUDIES = []; // se quiser conte√∫do offline, coloque objetos { topico, conteudo }
  const TEMPLATE_QUIZ_SIZE = 20;

  /* ===== demo config ===== */
  const PURCHASE_URL = 'https://seu-site-de-venda.com/checkout'; // <-- substitua pelo link de compra real
  const DEVICE_ID_KEY = 'quiz_device_id';
  const DEMO_LOCAL_KEY = 'quiz_demo_local'; // fallback quando servidor indispon√≠vel
  const DEMO_DURATION_HOURS = 24.0; // **0.5 horas = 30 minutos** (editar aqui para alterar dura√ß√£o)

  /* =========== estado e chaves =========== */
  let POOL = []; let currentIndex = 0; let score = 0; let errors = []; let quizStarted = false;
  const SOUND_KEY = 'quiz_sound_on'; const SCALE_KEY = 'quiz_card_scale'; const BEST_KEY = 'quiz_best_record';
  const scaleMin = 0.8, scaleMax = 1.6, scaleStep = 0.05;

  /* ====== helpers compatibilidade ====== */
  function q_text(q){ if (!q) return ''; return q.pergunta || q.perguntas || q.question || q.Question || q.Pergunta || ''; }
  function q_topic(q){ if (!q) return ''; return q.materia || q.topico || q.t√≥pico || q.topic || ''; }
  function q_expl(q){ if (!q) return ''; return q.explicacao || q.explanation || q.Explicacao || q.resposta || q.respostas || q.answer || ''; }
  function q_answer_letter(q){ const a = (q.resposta || q.answer || q.Resposta || q.Answer || '').toString().trim(); if (!a) return ''; return a.substr(0,1).toUpperCase(); }
  function q_option(q, letter){ const up = q[letter.toUpperCase()]; if (up !== undefined && up !== null && up !== '') return up; const low = q[letter.toLowerCase()]; if (low !== undefined && low !== null && low !== '') return low; return ''; }

  function linkify(text){ if (!text) return ''; let out = text.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); const urlPattern = /(\bhttps?:\/\/[^\s<]+[^\s<.,;:!?])/gi; const wwwPattern = /(^|[^\/])(www\.[^\s<]+[^\s<.,;:!?])/gi; out = out.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); out = out.replace(wwwPattern, '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>'); out = out.replace(/\n/g, '<br>'); return out; }

  /* ===== scale controls ===== */
  function readSavedScale(){ const s = parseFloat(localStorage.getItem(SCALE_KEY)); if (!isNaN(s)) return Math.max(scaleMin, Math.min(scaleMax, s)); const css = getComputedStyle(document.documentElement).getPropertyValue('--card-scale'); return parseFloat(css) || 1.10; }
  function setScale(v){ v = Math.max(scaleMin, Math.min(scaleMax, Number(v))); document.documentElement.style.setProperty('--card-scale', v.toFixed(2)); const lbl = document.getElementById('scaleLabel'); if (lbl) lbl.innerText = 'x' + v.toFixed(2); localStorage.setItem(SCALE_KEY, v.toFixed(2)); }
  document.getElementById('scaleUpBtn').addEventListener('click', ()=> setScale(readSavedScale() + scaleStep));
  document.getElementById('scaleDownBtn').addEventListener('click', ()=> setScale(readSavedScale() - scaleStep));

  /* ===== fullscreen ===== */
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  function updateFullscreenButton(){ const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement); fullscreenBtn.innerText = isFs ? 'ü°º' : '‚õ∂'; }
  fullscreenBtn.addEventListener('click', async ()=>{ try { if (!document.fullscreenElement && !document.webkitFullscreenElement) { if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); else if (document.documentElement.webkitRequestFullscreen) await document.documentElement.webkitRequestFullscreen(); } else { if (document.exitFullscreen) await document.exitFullscreen(); else if (document.webkitExitFullscreen) await document.webkitExitFullscreen(); } } catch(e){} });
  document.addEventListener('fullscreenchange', updateFullscreenButton);
  document.addEventListener('webkitfullscreenchange', updateFullscreenButton);

  /* ===== sound ===== */
  function isSoundOn(){ return localStorage.getItem(SOUND_KEY) !== '0'; }
  function setSoundOn(v){ localStorage.setItem(SOUND_KEY, v ? '1' : '0'); updateSoundBtn(); }
  function updateSoundBtn(){ document.getElementById('soundToggle').innerText = isSoundOn() ? 'üîä Som: On' : 'üîá Som: Off'; }
  document.getElementById('soundToggle').addEventListener('click', ()=> setSoundOn(!isSoundOn()));
  if (localStorage.getItem(SOUND_KEY) === null) localStorage.setItem(SOUND_KEY,'1');
  updateSoundBtn();

  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  function playTone(freq, dur=120, type='sine', gainVal=0.06){ if (!isSoundOn()) return; try{ ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = type; o.frequency.value = freq; g.gain.value = gainVal; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, dur); }catch(e){} }
  function playCorrect(){ playTone(880,120,'sine',0.06); }
  function playWrong(){ playTone(220,220,'sawtooth',0.08); }

  /* ===== navigation/pages ===== */
  let demoTimer = null; let demoExpiresAt = null; let demoLocked = false; let demoSource = null; // 'server' or 'local'
  function isDemoLocked(){ return demoLocked; }

  // ===== CORRE√á√ÉO: fun√ß√£o global go(target) adicionada (faltava) =====
  window.go = function(target){
    if (isDemoLocked()) return;
    // remove active from all pages, add to target
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const tEl = document.getElementById(target);
    if (tEl) tEl.classList.add('active');
    // update tab buttons
    document.querySelectorAll('.tabbtn').forEach(b => b.classList.toggle('active', b.dataset.target === target));
    // lazy actions on page show
    if (target === 'home') showBestRecord();
    if (target === 'study') renderStudies();
    if (target === 'cards') renderCards();
    if (target === 'quiz') { if (!quizStarted) showTopicSelection(); }
  };

  function showDemoBanner(remainingMs){
    const banner = document.getElementById('demoBanner');
    if (!banner) return;
    if (remainingMs <= 0) { banner.style.display='none'; return; }
    banner.style.display='inline-flex';
    document.getElementById('demoRemaining').innerText = formatRemaining(remainingMs);
  }

  function formatRemaining(ms){
    if (ms <= 0) return '00:00:00';
    const s = Math.floor(ms/1000); const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60;
    return `${pad(h)}:${pad(m)}:${pad(sec)}`;
  }
  function pad(n){ return n.toString().padStart(2,'0'); }

  /* ===== deviceId helpers (server per-device) ===== */
  function _makeDeviceId(){ return 'dev-' + Date.now() + '-' + Math.random().toString(36).slice(2,10); }
  async function ensureDeviceId(){ let id = localStorage.getItem(DEVICE_ID_KEY); if (!id){ id = _makeDeviceId(); localStorage.setItem(DEVICE_ID_KEY,id); } return id; }
  async function getDemoStatusServer(deviceId){
    const res = await fetch(`${SCRIPT_URL}?action=getDemoStatus&deviceId=${encodeURIComponent(deviceId)}`, { cache:'no-store' });
    return await res.json();
  }
  async function startDemoServer(deviceId, hours){
    const res = await fetch(`${SCRIPT_URL}?action=startDemo&deviceId=${encodeURIComponent(deviceId)}&durationHours=${Number(hours)}`, { cache:'no-store' });
    return await res.json();
  }

  async function checkAndStartDemo(){
    // server-first but per-device: envia deviceId ao servidor
    const deviceId = await ensureDeviceId();
    try {
      const js = await getDemoStatusServer(deviceId);
      if (js && js.ok){
        if (js.demoActive && js.expiresAt){
          setDemoState(new Date(js.expiresAt), 'server');
          return;
        }
        if (js.used){
          // servidor indica que dispositivo j√° usou demo -> bloqueio permanente
          lockApp({ permanent:true, title:'Demo j√° utilizada', message:'A demo deste dispositivo j√° foi utilizada. Para continuar, adquira a vers√£o paga.' });
          return;
        }
        // tentar criar demo para esse device (server)
        const start = await startDemoServer(deviceId, DEMO_DURATION_HOURS);
        if (start && start.ok && start.expiresAt){
          setDemoState(new Date(start.expiresAt), 'server');
          return;
        }
      }
    } catch (err){
      console.warn('Demo server endpoints indispon√≠veis, fallback local', err);
    }

    // fallback local (cliente)
    const local = JSON.parse(localStorage.getItem(DEMO_LOCAL_KEY) || 'null');
    if (local && local.expiresAt){
      setDemoState(new Date(local.expiresAt), 'local');
      return;
    }
    const now = Date.now(); const expires = new Date(now + DEMO_DURATION_HOURS*3600*1000);
    localStorage.setItem(DEMO_LOCAL_KEY, JSON.stringify({startedAt: new Date(now).toISOString(), expiresAt: expires.toISOString()}));
    setDemoState(expires, 'local');
  }

  /* ===== ALTERA√á√ÉO FEITA AQUI: lockApp agora mostra APENAS o link de compra (sem "Tentar reconectar") ===== */
  function lockApp(opts){
    demoLocked = true;
    if (document.getElementById('overlayLock')) return;
    const permanent = !!(opts && opts.permanent);
    const title = (opts && opts.title) ? opts.title : (permanent ? 'Acesso bloqueado' : 'Demo expirado');
    const msg = (opts && opts.message) ? opts.message : (permanent ? 'A demo j√° foi utilizada neste dispositivo.' : `Sua sess√£o demo de ${Math.round(DEMO_DURATION_HOURS*60)} minutos expirou e o aplicativo foi bloqueado.`);
    const overlay = document.createElement('div'); overlay.id = 'overlayLock'; overlay.className = 'overlay-lock';
    const card = document.createElement('div'); card.className='overlay-card';
    // Somente o link de compra ‚Äî removido o bot√£o "Tentar reconectar"
    card.innerHTML = `<h2>${title}</h2><p>${msg}</p><div style="display:flex;gap:8px;justify-content:center"><a class="linkbtn" href="${PURCHASE_URL}" target="_blank" rel="noopener noreferrer">Acessar vers√£o paga</a></div>`;
    overlay.appendChild(card);
    document.body.appendChild(overlay);

    // disable interactive controls visually & functionally
    document.getElementById('appRoot')?.style && (document.getElementById('appRoot').style.filter = 'blur(1px)');
    // desativa bot√µes/selects ‚Äî o overlay n√£o oferece reconex√£o, ent√£o apenas bloqueamos
    document.querySelectorAll('button,select').forEach(el => el.disabled = true);
  }

  function unlockAppClientSide(){
    // only for dev: clears local demo and device id
    localStorage.removeItem(DEMO_LOCAL_KEY);
    localStorage.removeItem(DEVICE_ID_KEY);
    if (document.getElementById('overlayLock')) document.getElementById('overlayLock').remove();
    document.getElementById('appRoot')?.style && (document.getElementById('appRoot').style.filter = '');
    document.querySelectorAll('button,select').forEach(el => el.disabled = false);
    demoLocked = false;
    checkAndStartDemo();
  }
  window.__unlockDemoForDev = unlockAppClientSide; // debug helper (remove in production)

  /* ====== ESTUDOS: fun√ß√£o que faltava (corrigida) ====== */
  async function renderStudies(){
    if (isDemoLocked()) return;
    const container = document.getElementById('studyList');
    if (!container) return;
    container.innerHTML = '';
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getStudies`, { cache:'no-store' });
      const js = await res.json();
      if (js && js.ok && js.studies && Array.isArray(js.studies) && js.studies.length){
        js.studies.forEach((s,i)=>{
          const d = document.createElement('details'); d.className='summary';
          const sum = document.createElement('summary'); sum.innerText = (s.topico || s.topic || `T√≥pico ${i+1}`);
          d.appendChild(sum);
          const div = document.createElement('div'); div.style.padding = '8px 6px'; div.style.color = '#dfeff5';
          div.innerHTML = linkify(s.conteudo || s.texto || s.conteudo || s.content || '');
          d.appendChild(div);
          container.appendChild(d);
        });
        return;
      }
    } catch(e){
      console.warn('Erro ao buscar estudos', e);
    }
    // fallback para TEMPLATE_STUDIES (se voc√™ quiser conte√∫do offline)
    if (!TEMPLATE_STUDIES || !Array.isArray(TEMPLATE_STUDIES) || TEMPLATE_STUDIES.length === 0){
      container.innerHTML = '<div class="small">Nenhum conte√∫do de estudo (adicione aba "Estudos" com colunas: T√≥pico | Conte√∫do).</div>';
      return;
    }
    TEMPLATE_STUDIES.forEach((s,i)=>{
      const d = document.createElement('details'); d.className='summary';
      const sum = document.createElement('summary'); sum.innerText = s.topico || s.title || `T√≥pico ${i+1}`;
      d.appendChild(sum);
      const div = document.createElement('div'); div.style.padding = '8px 6px'; div.style.color = '#dfeff5';
      div.innerHTML = linkify(s.conteudo || s.content || '');
      d.appendChild(div);
      container.appendChild(d);
    });
  }

  /* ===== quiz (id√™ntico ao anterior) ===== */
  const quizSizeLabel = document.getElementById('quizSizeLabel');
  quizSizeLabel.innerText = TEMPLATE_QUIZ_SIZE || 20;
  const topicSelect = document.getElementById('topicSelect');
  const loadTopicBtn = document.getElementById('loadTopicBtn');
  const nextBtn = document.getElementById('nextBtn');
  const optsDiv = document.getElementById('opts');
  const qEl = document.getElementById('question');
  const explainEl = document.getElementById('explain');
  const progressBar = document.getElementById('bar');
  const progressInfo = document.getElementById('progressInfo');
  const progressText = document.getElementById('progressText');
  const btnRestart = document.getElementById('btnRestart');

  loadTopicBtn.addEventListener('click', ()=> { if (isDemoLocked()) return; loadTopicQuestions(topicSelect.value); });
  nextBtn.addEventListener('click', ()=> { if (!quizStarted || isDemoLocked()) return; currentIndex++; renderQuestion(); });

  async function showTopicSelection(){
    populateTopicSelect(['Todos']);
    try {
      const res = await fetch(`${SCRIPT_URL}?action=getTopics`, {cache:'no-store'});
      const js = await res.json();
      if (js && js.ok && js.topics) { populateTopicSelect(js.topics || []); return; } else { console.warn('getTopics returned no topics', js); }
    } catch (e) { console.warn('Erro fetch topics', e); }
  }
  function populateTopicSelect(topics){ topicSelect.innerHTML = ''; const optAll = document.createElement('option'); optAll.value='Todos'; optAll.textContent='Todos'; topicSelect.appendChild(optAll); if (topics && topics.length){ topics.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; topicSelect.appendChild(o); }); } }

  async function loadTopicQuestions(topic){
    qEl.innerText = 'Carregando perguntas...';
    try {
      const encoded = encodeURIComponent(topic || 'Todos');
      const res = await fetch(`${SCRIPT_URL}?action=getQuestionsByTopic&topic=${encoded}`, {cache:'no-store'});
      const js = await res.json();
      let data = (js && js.ok && js.questions) ? js.questions.slice() : [];
      if (!data.length && TEMPLATE_QUESTIONS && TEMPLATE_QUESTIONS.length){ data = TEMPLATE_QUESTIONS.slice(0, TEMPLATE_QUIZ_SIZE); }
      POOL = data.slice(0, TEMPLATE_QUIZ_SIZE);
      currentIndex = 0; score = 0; errors = []; quizStarted = true;
      btnRestart.style.display = 'none';
      renderQuestion();
    } catch (err){ console.error('Erro ao carregar quest√µes:', err); qEl.innerText = 'Erro ao carregar quest√µes. Verifique a conex√£o.'; }
  }

  function renderQuestion(){
    explainEl.style.display = 'none';
    nextBtn.disabled = true;
    if (!POOL || POOL.length === 0) {
      qEl.innerText = 'Nenhuma quest√£o dispon√≠vel. Carregue outro t√≥pico ou verifique a planilha.';
      optsDiv.innerHTML = '';
      progressBar.style.width = '0%';
      progressInfo.innerText = '0 / 0';
      progressText.innerText = '';
      btnRestart.style.display = 'inline-block';
      quizStarted = false;
      return;
    }
    if (currentIndex >= POOL.length) { finishQuiz(); return; }
    const q = POOL[currentIndex];
    qEl.style.opacity = 0;
    setTimeout(()=>{ qEl.innerText = `üìò ${q_topic(q) || ''}\n${q_text(q)}`; qEl.style.opacity = 1; }, 120);

    optsDiv.innerHTML = '';
    ['A','B','C','D'].forEach(letter => {
      const txt = q_option(q, letter);
      if (!txt) return;
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.id = 'opt_' + letter;
      btn.innerText = `${letter}) ${txt}`;
      btn.onclick = ()=> selectOption(letter);
      optsDiv.appendChild(btn);
    });

    updateProgressUI();
  }

  function selectOption(letter){
    if (!quizStarted || isDemoLocked()) return;
    const q = POOL[currentIndex];
    const correct = q_answer_letter(q);
    const chosen = letter.toUpperCase();
    document.querySelectorAll('.opt').forEach(el => el.disabled = true);
    if (correct) {
      const elCorrect = document.getElementById('opt_' + correct);
      if (elCorrect) elCorrect.classList.add('correct');
    }
    const elChosen = document.getElementById('opt_' + chosen);
    if (elChosen) {
      if (chosen === correct) { elChosen.classList.add('correct'); playCorrect(); score++; }
      else { elChosen.classList.add('wrong'); playWrong(); errors.push(q); }
    } else { if (chosen !== correct) { playWrong(); errors.push(q); } else playCorrect(); }
    const title = (chosen === correct) ? '‚úÖ Correto!' : ('‚ùå Errado! Resposta: ' + (correct || '‚Äî'));
    showExplanation(title, q_expl(q));
    nextBtn.disabled = false;
  }

  function showExplanation(title, explanation){ explainEl.style.display = 'block'; explainEl.innerHTML = `<strong>${title}</strong><div style="margin-top:8px;color:#dfeff5">${explanation || ''}</div>`; }
  function updateProgressUI(){ const total = POOL.length || 0; const pct = total ? Math.round((currentIndex / total) * 100) : 0; progressBar.style.width = pct + '%'; progressInfo.innerText = `${currentIndex + 1} / ${total}`; progressText.innerText = `Pontos: ${score}`; }
  function finishQuiz(){ quizStarted = false; const total = POOL.length || 1; const pct = Math.round((score / total) * 100); const badge = pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üéâ' : pct >= 40 ? 'üëç' : 'üìò'; const finalTitle = `${badge} Voc√™ acertou ${score} de ${total} (${pct}%)`; qEl.innerText = finalTitle; optsDiv.innerHTML = ''; explainEl.style.display = 'block'; const rec = saveRecord(score, total); explainEl.innerHTML = `<div style="color:#dfeff5">${rec && rec.isNew ? 'üéØ Novo recorde! ' : ''}${rec && rec.record ? 'Seu recorde: ' + rec.record.score + '/' + rec.record.total + ' ('+rec.record.pct+'%)' : ''}</div>`; btnRestart.style.display = 'inline-block'; progressBar.style.width = '100%'; }
  function restartQuiz(){ if (topicSelect && topicSelect.value) loadTopicQuestions(topicSelect.value); else loadTopicQuestions('Todos'); }

  /* ===== local record ===== */
  function saveRecord(score, total){ try { const pct = Math.round((score/total)*100); const now = new Date().toISOString(); const current = {score: score, total: total, pct: pct, when: now}; const prev = JSON.parse(localStorage.getItem(BEST_KEY) || 'null'); if (!prev || pct > prev.pct) { localStorage.setItem(BEST_KEY, JSON.stringify(current)); return {isNew:true, record: current, prev: prev}; } else { return {isNew:false, record: prev}; } } catch(e){ return null; } }
  function getRecord(){ try { return JSON.parse(localStorage.getItem(BEST_KEY) || 'null'); } catch(e){ return null; } }
  function showBestRecord(){ const rec = getRecord(); const el = document.getElementById('bestRecord'); if (!rec) el.innerText = 'Ainda sem recorde. Fa√ßa um quiz e apare√ßa aqui!'; else el.innerText = `Seu recorde: ${rec.score}/${rec.total} (${rec.pct}%) ‚Äî em ${new Date(rec.when).toLocaleString()}`; }

  /* ====== CART√ïES (for√ßando endpoint getCards) ====== */
  async function renderCards(){
    if (isDemoLocked()) return;
    const container = document.getElementById('cardsContainer');
    container.innerHTML = '';
    // nome da aba que voc√™ criou (exato). Se usar outro nome, troque aqui.
    const sheetName = 'cart√µes';
    const encoded = encodeURIComponent(sheetName);
    const endpointsTried = [];
    try {
      // 1) tenta endpoint getCards (espec√≠fico)
      const urlCards = `${SCRIPT_URL}?action=getCards&sheet=${encoded}`;
      endpointsTried.push(urlCards);
      console.log('Tentando endpoint (getCards):', urlCards);
      let res = await fetch(urlCards, {cache:'no-store'});
      let js = await res.json();
      console.log('Resposta getCards:', js);
      let list = null;
      if (js && js.ok && js.cards && Array.isArray(js.cards) && js.cards.length) {
        list = js.cards;
      } else if (js && js.ok && Array.isArray(js)) {
        list = js;
      } else if (js && js.ok && js.sheet && js.sheet.rows && Array.isArray(js.sheet.rows) && js.sheet.rows.length) {
        // caso getSheetByName retorne sheet
        list = js.sheet.rows;
      }
      // 2) se n√£o encontrou nada, tenta getQuestionsBySheet
      if (!list || !list.length) {
        const urlQSheet = `${SCRIPT_URL}?action=getQuestionsBySheet&sheet=${encoded}`;
        endpointsTried.push(urlQSheet);
        console.log('getCards vazio ‚Äî tentando getQuestionsBySheet:', urlQSheet);
        res = await fetch(urlQSheet, {cache:'no-store'});
        js = await res.json();
        console.log('Resposta getQuestionsBySheet:', js);
        if (js && js.ok && js.questions && Array.isArray(js.questions) && js.questions.length) {
          list = js.questions;
        } else if (js && js.ok && Array.isArray(js)) {
          list = js;
        } else if (js && js.ok && js.cards && Array.isArray(js.cards)) {
          list = js.cards;
        }
      }
      // 3) fallback para getAllQuestions (√∫ltimo recurso)
      if (!list || !list.length) {
        const urlAll = `${SCRIPT_URL}?action=getAllQuestions`;
        endpointsTried.push(urlAll);
        console.log('Ainda vazio ‚Äî tentando getAllQuestions:', urlAll);
        res = await fetch(urlAll, {cache:'no-store'});
        js = await res.json();
        console.log('Resposta getAllQuestions:', js);
        if (js && js.ok && js.questions && Array.isArray(js.questions) && js.questions.length) {
          list = js.questions;
        }
      }

      console.log('Endpoints tentados:', endpointsTried);
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="small">Nenhum cart√£o dispon√≠vel na aba "<strong>cart√µes</strong>". Verifique o nome da aba e os cabe√ßalhos (pergunta | resposta).</div>';
        return;
      }

      // Se list √© array de arrays (planilha bruta), transforma em objetos simples
      if (Array.isArray(list[0]) && !list[0].pergunta && !list[0].question) {
        // assume primeira linha header
        const headers = list[0].map(h => (h===null? '': h.toString()));
        const rows = list.slice(1);
        const mapped = rows.map(row=>{
          const obj = {};
          row.forEach((val,i)=> obj[ (headers[i]||i) ] = val );
          return obj;
        });
        makeCards(mapped);
        return;
      }

      // j√° temos objetos ‚Äî normaliza e cria cart√µes
      makeCards(list);
    } catch(e){
      console.error('Erro renderCards:', e);
      container.innerHTML = '<div class="small">Erro ao buscar cart√µes. Abra o console para ver detalhes.</div>';
    }
  }

  function makeCards(list){
    const container = document.getElementById('cardsContainer');
    container.innerHTML = '';
    if (!list || list.length === 0) { container.innerHTML = '<div class="small">Nenhum cart√£o dispon√≠vel.</div>'; return; }
    // shuffle
    for (let i = list.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [list[i], list[j]] = [list[j], list[i]]; }
    list.forEach((q, idx)=>{
      // Suporta formatos variados:
      // - q.pergunta / q.resposta
      // - q.question / q.explanation
      // - objetos simples com colunas nomeadas
      const frontText = (q.pergunta || q.perguntas || q.question || q[Object.keys(q).find(k=>/perg/i.test(k))] || '').toString();
      const topicText = (q.topico || q.t√≥pico || q.materia || q.categoria || q.topic || '').toString();
      const backText = (q.resposta || q.respostas || q.explanation || q.explicacao || q.answer || q[Object.keys(q).find(k=>/resp/i.test(k))] || '').toString();

      const wrapper = document.createElement('div'); wrapper.className = 'flashcard card-small';
      const inner = document.createElement('div'); inner.className = 'flash-inner';
      const front = document.createElement('div'); front.className = 'flash-front';
      const back = document.createElement('div'); back.className = 'flash-back';

      front.innerHTML = `<div style="font-size:12px;color:#dfeff5">${topicText}</div><div style="font-weight:800;margin-top:8px">${frontText}</div><div style="margin-top:8px;font-size:13px;color:#bfeadf">Clique para ver explica√ß√£o</div>`;
      back.innerHTML = `<div style="font-size:12px;color:#dfeff5">${topicText}</div><div style="font-weight:800;margin-top:8px">${backText}</div>`;

      inner.appendChild(front); inner.appendChild(back);
      wrapper.appendChild(inner);
      wrapper.addEventListener('click', ()=> inner.classList.toggle('flipped'));
      container.appendChild(wrapper);
    });
  }

  /* ===== inicializa√ß√£o ===== */
  (function init(){
    const cssScale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-scale')) || 1.10;
    if (localStorage.getItem(SCALE_KEY) === null) localStorage.setItem(SCALE_KEY, cssScale.toFixed(2));
    if (window.innerWidth <= 520) localStorage.setItem(SCALE_KEY, '1.10');
    setScale(readSavedScale());

    // start demo check (server-first, per-device)
    checkAndStartDemo();

    // carregar estudos inicialmente (ou quando aba for aberta)
    renderStudies();
    showTopicSelection();
    showBestRecord();
    window.addEventListener('click', function unlock(){ try{ ensureAudio(); }catch(e){} window.removeEventListener('click', unlock); }, { once:true });
    document.getElementById('quizSizeLabel').innerText = TEMPLATE_QUIZ_SIZE || 20;

    // buy button
    document.getElementById('buyBtn').addEventListener('click', ()=> { window.open(PURCHASE_URL, '_blank', 'noopener'); });

    // expose a debug unlock helper on window for dev (ONLY for testing)
    window.__unlockDemoForDev = unlockAppClientSide;
  })();

</script>
</body>
</html>
