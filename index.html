<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Quiz Guarda Civil ‚Äî App</title>
  <meta name="theme-color" content="#1e3c72"/>
  <style>
    /* ... seu CSS (igual ao original) ... */
    :root{ --bg1:#0f3b6b; --bg2:#1f6fb0; --card-bg: rgba(255,255,255,0.06); --muted: rgba(255,255,255,0.92); --accent: #00ff9d; --card-scale: 1.10; }
    html,body{height:100%;margin:0;padding:0}
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background: linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; display:flex; align-items:center; justify-content:center; padding:env(safe-area-inset-top) 12px calc(env(safe-area-inset-bottom) + 12px) 12px; }
    .app { width:100%; max-width:920px; display:flex; flex-direction:column; gap:12px; }
    .card { background: var(--card-bg); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,0.28); backdrop-filter: blur(6px); transform: scale(var(--card-scale)); transform-origin: top center; transition: transform .12s ease; }
    .header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .header > div:first-child { flex: 1 1 auto; min-width: 0; }
    .controls { flex: 0 0 auto; display:flex; gap:8px; align-items:center; }
    .title { font-size: clamp(18px,4vw,22px); margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; }
    .subtitle { font-size:13px; color:#e6f7f0; margin-top:6px; }
    .btn { background:transparent;border:1px solid rgba(255,255,255,0.12); color:#fff;padding:8px 10px;border-radius:10px;font-weight:700; cursor:pointer; }
    .icon-btn { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; border:1px solid rgba(255,255,255,0.08); background:transparent; color:#fff; cursor:pointer; }
    .scale-label { min-width:62px; text-align:center; font-weight:800; }
    .pages { min-height:340px; padding-bottom: 72px; }
    .page { display:none; }
    .page.active { display:block; animation: fadeIn .22s ease; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
    .welcome { font-size:18px; margin:6px 0 12px 0; color:var(--muted); }
    .home-actions { display:flex; gap:10px; margin-top:8px; flex-wrap:wrap; }
    .study-list { display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    details.summary { background: rgba(255,255,255,0.03); padding:10px; border-radius:10px; color:#fff; }
    summary { font-weight:800; cursor:pointer; padding:8px 6px; outline:none; }
    .progress { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
    .track { flex:1; height:12px; background:rgba(255,255,255,0.10); border-radius:999px; overflow:hidden; }
    .bar { height:12px; width:0; background: linear-gradient(90deg, rgba(0,255,157,0.95), rgba(0,214,138,0.95)); transition: width .45s ease; border-radius:999px; }
    .question { margin:12px 0; font-size:18px; color:var(--muted); transition:opacity .2s, transform .2s; white-space:pre-wrap; }
    .opts { display:grid; gap:10px; grid-template-columns:1fr 1fr; }
    button.opt { padding:14px; min-height:62px; border-radius:12px; border:1px solid rgba(255,255,255,0.08); background:#fff; color:#123; font-weight:800; cursor:pointer; text-align:left; }
    button.opt[disabled]{ opacity:.8; cursor:not-allowed; }
    .opt.correct{ background:#e9fff2; border-color:#2fa764; }
    .opt.wrong{ background:#fff0f0; border-color:#ff6b6b; }
    .explain { margin-top:12px; padding:12px; background:rgba(255,255,255,0.04); border-radius:10px; color:#fff; }
    .final { text-align:center; padding:12px; }
    .record { margin-top:8px; font-size:14px; color:#e6f7f0; }
    .tabs { display:flex; justify-content:space-around; gap:6px; margin-top:16px; margin-bottom: calc(env(safe-area-inset-bottom) + 8px); position: relative; z-index: 20; }
    .tabbtn { flex:1; padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#fff;font-weight:800;cursor:pointer;text-align:center; }
    .tabbtn.active{ background: rgba(255,255,255,0.06); }
    .small { font-size:13px; color:#dfeff5; }
    .topic-select { display:flex; gap:8px; align-items:center; margin-bottom:10px; flex-wrap:wrap; }
    .next-area { display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:10px; flex-wrap:wrap; }
    .next-btn { background: linear-gradient(90deg,var(--accent), #2fb6ff); border:none; color:#012; font-weight:900; padding:12px 16px; border-radius:12px; cursor:pointer; font-size:16px; }
    .next-btn:disabled { opacity:0.6; cursor:not-allowed; }
    .next-btn.small-btn { padding: 8px 12px; font-size: 14px; border-radius: 10px; }
    .card-small { padding:10px; border-radius:10px; background:rgba(255,255,255,0.03); margin-bottom:8px; }
    .flashcard { perspective:1000px; cursor:pointer; }
    .flash-inner { transition: transform .5s; transform-style: preserve-3d; position:relative; min-height:120px; }
    .flash-front, .flash-back { backface-visibility: hidden; position:absolute; inset:0; border-radius:10px; padding:14px; display:flex; flex-direction:column; justify-content:center; }
    .flash-front { background:rgba(255,255,255,0.02); color:#fff; }
    .flash-back { transform: rotateY(180deg); background:rgba(0,0,0,0.12); color:#fff; }
    .flash-inner.flipped { transform: rotateY(180deg); }
    .demo-banner { background: rgba(0,0,0,0.2); padding:6px 10px; border-radius:8px; font-weight:800; display:inline-flex; gap:8px; align-items:center; position:relative; z-index:30; }
    .demo-remaining { font-size:13px; color:#dfffe8; }
    .overlay-lock { position:fixed; inset:0; background:rgba(3,6,12,0.7); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .overlay-card { background:#081a2b; padding:20px; border-radius:12px; box-shadow: 0 8px 30px rgba(0,0,0,0.6); max-width:420px; text-align:center; color:#fff; }
    .overlay-card h2{ margin:0 0 8px 0; }
    .overlay-card p{ margin:8px 0 14px 0; color:#d5f5e7 }
    .overlay-card .linkbtn{ display:inline-block; padding:10px 14px; border-radius:10px; background:linear-gradient(90deg,var(--accent), #2fb6ff); color:#012; font-weight:800; text-decoration:none; }
    @media (max-width:520px){
      .header { flex-wrap:wrap; align-items:center; }
      .header > div:first-child { order: 1; flex: 1 1 100%; min-width:0; }
      .controls { order: 2; flex: 1 1 100%; display:flex; justify-content:flex-start; gap:6px; margin-top:8px; }
      .title { white-space:normal; font-size:16px; }
      .controls .icon-btn { width:34px; height:34px; }
      .controls .btn { padding:6px 8px; font-size:13px; }
      .scale-label { min-width:46px; font-size:13px; text-align:center; }
      .pages { padding-bottom: 92px; }
      .tabs { margin-top:18px; margin-bottom: calc(env(safe-area-inset-bottom) + 12px); }
    }
    @media (max-width:420px){ .title { font-size:15px; } .controls { justify-content:flex-start; gap:6px; } }
    @media (max-width:520px){ .opts{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="app" style="width:100%;max-width:820px;" id="appRoot">

    <!-- HEADER -->
    <div class="card header" id="cardHeader">
      <div>
        <h1 class="title">Quiz Guarda Civil üëÆ‚Äç‚ôÇÔ∏è</h1>
        <div class="subtitle">Estude por t√≥picos </div>
      </div>

      <div class="controls">
        <div id="demoBanner" class="demo-banner" style="display:none">
          <div style="font-size:13px;">DEMO</div>
          <div class="demo-remaining" id="demoRemaining">‚Äî</div>
        </div>
        <button class="icon-btn" id="scaleDownBtn" title="Diminuir caixa">A‚àí</button>
        <div class="scale-label" id="scaleLabel">x1.10</div>
        <button class="icon-btn" id="scaleUpBtn" title="Aumentar caixa">A+</button>
        <button class="icon-btn" id="fullscreenBtn" title="Tela cheia">‚õ∂</button>
        <button class="btn" id="soundToggle">üîä Som: On</button>
        <button class="btn" id="buyBtn" title="Adquirir vers√£o paga">üí≥ Comprar</button>
      </div>
    </div>

    <!-- PAGES -->
    <div class="card pages" id="pages">
      <section id="home" class="page active">
        <div class="welcome">Ol√°! Escolha um t√≥pico e inicie o quiz quando estiver pronto.</div>
        <div class="home-actions">
          <button class="btn" onclick="go('study')" id="btnStudy">üìò Estudar</button>
          <button class="btn" onclick="go('quiz')" id="btnQuiz">üéØ Fazer Quiz</button>
          <button class="btn" onclick="go('cards')" id="btnCards">üÉè Cart√µes</button>
        </div>
        <div style="margin-top:12px">
          <div id="bestRecord" class="record">Carregando recorde...</div>
        </div>
      </section>

      <section id="study" class="page">
        <h3>Conte√∫dos de Estudo</h3>
        <div id="studyList" class="study-list"></div>
      </section>

      <section id="quiz" class="page">
        <div class="topic-select">
          <div class="average">Escolha o T√≥pico:</div>
          <select id="topicSelect" class="average"></select>
          <button class="next-btn small-btn" id="loadTopicBtn">Carregar t√≥pico</button>
          <div style="flex:1"></div>
          <div class="small" id="quizNote">Quest√µes por rodada: <strong id="quizSizeLabel"></strong></div>
        </div>

        <div class="progress" style="margin-bottom:8px">
          <div class="track"><div class="bar" id="bar" style="width:0%"></div></div>
          <div class="small" id="progressInfo">0 / 0</div>
        </div>

        <div class="question" id="question">Aguardando escolha do t√≥pico...</div>
        <div class="opts" id="opts"></div>
        <div class="explain" id="explain" style="display:none"></div>

        <div class="next-area">
          <div id="progressText" class="small"></div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="btnRestart" onclick="restartQuiz()" style="display:none">üîÑ Reiniciar</button>
            <button class="next-btn" id="nextBtn" disabled>Pr√≥xima ‚ûú</button>
          </div>
        </div>
      </section>

      <section id="cards" class="page">
        <h3>Cart√µes (clique para virar)</h3>
        <div id="cardsContainer" style="display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px;"></div>
      </section>
    </div>

    <div class="tabs card" role="navigation" aria-label="Navega√ß√£o">
      <button class="tabbtn active" data-target="home" onclick="go('home')">In√≠cio</button>
      <button class="tabbtn" data-target="study" onclick="go('study')">Estudo</button>
      <button class="tabbtn" data-target="quiz" onclick="go('quiz')">Quiz</button>
      <button class="tabbtn" data-target="cards" onclick="go('cards')">Cart√µes</button>
    </div>

  </div>

<script>
  /* ===================== CONFIGURE AQUI ===================== */
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5EBfk9tKhjkfjgZtyw4YK6Ve-eNRtFFEQAC4TU2WkvhF1_ex_9lVNIPG0mJW3V3EKxA/exec';
  const TEMPLATE_QUESTIONS = null;
  const TEMPLATE_STUDIES = [];
  const TEMPLATE_QUIZ_SIZE = 20;

  /* ===== demo config ===== */
  const PURCHASE_URL = 'https://seu-site-de-venda.com/checkout';
  const DEVICE_ID_KEY = 'quiz_device_id';
  const DEMO_LOCAL_KEY = 'quiz_demo_local';
  const DEMO_DURATION_HOURS = 24.0;

  /* =========== estado e chaves =========== */
  let POOL = []; let currentIndex = 0; let score = 0; let errors = []; let quizStarted = false;
  const SOUND_KEY = 'quiz_sound_on'; const SCALE_KEY = 'quiz_card_scale'; const BEST_KEY = 'quiz_best_record';
  const scaleMin = 0.8, scaleMax = 1.6, scaleStep = 0.05;

  /* ====== helpers compatibilidade ====== */
  function q_text(q){ if (!q) return ''; return q.pergunta || q.perguntas || q.question || q.Question || q.Pergunta || ''; }
  function q_topic(q){ if (!q) return ''; return q.materia || q.topico || q.t√≥pico || q.topic || ''; }
  function q_expl(q){ if (!q) return ''; return q.explicacao || q.explanation || q.Explicacao || q.resposta || q.respostas || q.answer || ''; }
  function q_answer_letter(q){ const a = (q.resposta || q.answer || q.Resposta || q.Answer || '').toString().trim(); if (!a) return ''; return a.substr(0,1).toUpperCase(); }
  function q_option(q, letter){ const up = q[letter.toUpperCase()]; if (up !== undefined && up !== null && up !== '') return up; const low = q[letter.toLowerCase()]; if (low !== undefined && low !== null && low !== '') return low; return ''; }

  function linkify(text){ if (!text) return ''; let out = text.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); const urlPattern = /(\bhttps?:\/\/[^\s<]+[^\s<.,;:!?])/gi; const wwwPattern = /(^|[^\/])(www\.[^\s<]+[^\s<.,;:!?])/gi; out = out.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'); out = out.replace(wwwPattern, '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>'); out = out.replace(/\n/g, '<br>'); return out; }

  /* ===== scale, fullscreen, sound etc (id√™nticos ao seu c√≥digo original) ===== */
  function readSavedScale(){ const s = parseFloat(localStorage.getItem(SCALE_KEY)); if (!isNaN(s)) return Math.max(scaleMin, Math.min(scaleMax, s)); const css = getComputedStyle(document.documentElement).getPropertyValue('--card-scale'); return parseFloat(css) || 1.10; }
  function setScale(v){ v = Math.max(scaleMin, Math.min(scaleMax, Number(v))); document.documentElement.style.setProperty('--card-scale', v.toFixed(2)); const lbl = document.getElementById('scaleLabel'); if (lbl) lbl.innerText = 'x' + v.toFixed(2); localStorage.setItem(SCALE_KEY, v.toFixed(2)); }
  document.getElementById('scaleUpBtn').addEventListener('click', ()=> setScale(readSavedScale() + scaleStep));
  document.getElementById('scaleDownBtn').addEventListener('click', ()=> setScale(readSavedScale() - scaleStep));
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  function updateFullscreenButton(){ const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement); fullscreenBtn.innerText = isFs ? 'ü°º' : '‚õ∂'; }
  fullscreenBtn.addEventListener('click', async ()=>{ try { if (!document.fullscreenElement && !document.webkitFullscreenElement) { if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen(); else if (document.documentElement.webkitRequestFullscreen) await document.documentElement.webkitRequestFullscreen(); } else { if (document.exitFullscreen) await document.exitFullscreen(); else if (document.webkitExitFullscreen) await document.webkitExitFullscreen(); } } catch(e){} });
  document.addEventListener('fullscreenchange', updateFullscreenButton);
  document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
  function isSoundOn(){ return localStorage.getItem(SOUND_KEY) !== '0'; }
  function setSoundOn(v){ localStorage.setItem(SOUND_KEY, v ? '1' : '0'); updateSoundBtn(); }
  function updateSoundBtn(){ document.getElementById('soundToggle').innerText = isSoundOn() ? 'üîä Som: On' : 'üîá Som: Off'; }
  document.getElementById('soundToggle').addEventListener('click', ()=> setSoundOn(!isSoundOn()));
  if (localStorage.getItem(SOUND_KEY) === null) localStorage.setItem(SOUND_KEY,'1');
  updateSoundBtn();
  let audioCtx = null;
  function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
  function playTone(freq, dur=120, type='sine', gainVal=0.06){ if (!isSoundOn()) return; try{ ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = type; o.frequency.value = freq; g.gain.value = gainVal; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, dur); }catch(e){} }
  function playCorrect(){ playTone(880,120,'sine',0.06); }
  function playWrong(){ playTone(220,220,'sawtooth',0.08); }

  /* ===== navigation/pages and demo state ===== */
  let demoTimer = null; let demoExpiresAt = null; let demoLocked = false; let demoSource = null;
  function isDemoLocked(){ return demoLocked; }
  window.go = function(target){
    if (isDemoLocked()) return;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const tEl = document.getElementById(target);
    if (tEl) tEl.classList.add('active');
    document.querySelectorAll('.tabbtn').forEach(b => b.classList.toggle('active', b.dataset.target === target));
    if (target === 'home') showBestRecord();
    if (target === 'study') renderStudies();
    if (target === 'cards') renderCards();
    if (target === 'quiz') { if (!quizStarted) showTopicSelection(); }
  };

  /* ========== NOVA PARTE: Fingerprint-based deviceId (resiste a limpeza do localStorage) ========== */

  // hash helper
  async function hashString(input){
    try {
      const enc = new TextEncoder().encode(input);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    } catch(e){
      console.warn('hashString failed', e);
      return null;
    }
  }

  // canvas fingerprint small helper
  async function canvasFingerprint(){
    try {
      const canvas = document.createElement('canvas');
      canvas.width = 200; canvas.height = 50;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#f60';
      ctx.fillRect(0,0,200,50);
      ctx.fillStyle = '#069';
      ctx.font = '14px Arial';
      ctx.fillText('QuizGuard', 10, 20);
      ctx.fillStyle = 'rgba(102,204,0,0.7)';
      ctx.fillText(navigator.userAgent || '', 10, 36);
      // small toDataURL
      return canvas.toDataURL();
    } catch(e){
      return '';
    }
  }

  // generate a fingerprint string and hash it
  async function generateFingerprint(){
    try {
      const parts = [];
      parts.push(navigator.userAgent || '');
      parts.push(navigator.platform || '');
      parts.push(navigator.language || '');
      parts.push(screen.width + 'x' + screen.height + 'x' + (screen.colorDepth || ''));
      parts.push(String(navigator.hardwareConcurrency || ''));
      // deviceMemory may be undefined in some browsers
      if (navigator.deviceMemory) parts.push(String(navigator.deviceMemory));
      try {
        parts.push(Intl.DateTimeFormat().resolvedOptions().timeZone || '');
      } catch(e){}
      // small sampling of mimeTypes to add entropy when allowed
      try {
        if (navigator.mimeTypes && navigator.mimeTypes.length) {
          const m = Array.from(navigator.mimeTypes).slice(0,6).map(x=>x.type).join(',');
          parts.push(m);
        }
      } catch(e){}
      // canvas
      const canv = await canvasFingerprint();
      parts.push(canv || '');
      const raw = parts.join('||');
      const h = await hashString(raw);
      return h; // hex string (64 chars)
    } catch(e){
      console.warn('generateFingerprint failed', e);
      return null;
    }
  }

  // ensureDeviceId now uses fingerprint; stores in localStorage for performance,
  // but if localStorage cleared it will recompute same fingerprint (most cases)
  async function ensureDeviceId(){
    try {
      let id = localStorage.getItem(DEVICE_ID_KEY);
      if (id && id.startsWith('fp-')) return id;
      // compute fingerprint
      const fp = await generateFingerprint();
      if (fp && fp.length === 64) {
        id = 'fp-' + fp;
        try { localStorage.setItem(DEVICE_ID_KEY, id); } catch(e){ /* ignore */ }
        return id;
      }
    } catch(e){
      console.warn('ensureDeviceId fingerprint flow failed', e);
    }
    // fallback: keep a persisted random id if possible
    let fallback = localStorage.getItem(DEVICE_ID_KEY);
    if (!fallback) {
      fallback = 'dev-' + Date.now() + '-' + Math.random().toString(36).slice(2,10);
      try { localStorage.setItem(DEVICE_ID_KEY, fallback); } catch(e){ /* ignore */ }
    }
    return fallback;
  }

  // ===== server helpers (unchanged) =====
  async function getDemoStatusServer(deviceId){
    const res = await fetch(`${SCRIPT_URL}?action=getDemoStatus&deviceId=${encodeURIComponent(deviceId)}`, { cache:'no-store' });
    return await res.json();
  }
  async function startDemoServer(deviceId, hours){
    const res = await fetch(`${SCRIPT_URL}?action=startDemo&deviceId=${encodeURIComponent(deviceId)}&durationHours=${Number(hours)}`, { cache:'no-store' });
    return await res.json();
  }

  /* ===== set/show demo state (igual ao patch anterior) ===== */
  function showDemoBanner(remainingMs){
    const banner = document.getElementById('demoBanner');
    const remEl = document.getElementById('demoRemaining');
    if (!banner || !remEl) return;
    const msNum = Number(remainingMs);
    if (!Number.isFinite(msNum) || msNum <= 0) { banner.style.display = 'none'; remEl.innerText = '00:00:00'; return; }
    banner.style.display = 'inline-flex';
    remEl.innerText = formatRemaining(Math.max(0, Math.floor(msNum)));
  }

  function setDemoState(expiresDate, source){
    demoSource = source || 'local';
    let parsed = null;
    if (expiresDate instanceof Date && !isNaN(expiresDate)) parsed = expiresDate;
    else {
      const s = String(expiresDate || '');
      const parsedISO = Date.parse(s);
      if (!isNaN(parsedISO)) parsed = new Date(parsedISO);
      else {
        const n = Number(expiresDate);
        if (!isNaN(n)) parsed = new Date(n);
      }
    }
    if (!parsed || isNaN(parsed)) { if (demoTimer) { clearInterval(demoTimer); demoTimer = null; } showDemoBanner(0); return; }
    demoExpiresAt = parsed;
    try { localStorage.setItem(DEMO_LOCAL_KEY, JSON.stringify({ startedAt: new Date().toISOString(), expiresAt: demoExpiresAt.toISOString(), source: demoSource })); } catch(e){}
    if (demoTimer) clearInterval(demoTimer);
    const update = () => {
      const now = new Date();
      const rem = demoExpiresAt - now;
      if (!Number.isFinite(rem) || rem <= 0) { if (demoTimer) { clearInterval(demoTimer); demoTimer = null; } showDemoBanner(0); lockApp(); return; }
      showDemoBanner(rem);
    };
    update();
    demoTimer = setInterval(update, 1000);
  }

  function formatRemaining(ms){ if (!Number.isFinite(ms) || ms <= 0) return '00:00:00'; const s = Math.floor(ms/1000); const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60); const sec = s%60; return `${pad(h)}:${pad(m)}:${pad(sec)}`; }
  function pad(n){ return n.toString().padStart(2,'0'); }

  /* ===== checkAndStartDemo (server-first, using fingerprinted deviceId) ===== */
  async function checkAndStartDemo(){
    const deviceId = await ensureDeviceId();
    console.log('checkAndStartDemo -> deviceId:', deviceId, 'SCRIPT_URL:', SCRIPT_URL);
    try {
      const js = await getDemoStatusServer(deviceId);
      console.log('getDemoStatus server result:', js);
      if (js && js.ok){
        if (js.demoActive && js.expiresAt){
          setDemoState(js.expiresAt, 'server');
          return;
        }
        if (js.used){
          lockApp({ permanent:true, title:'Demo j√° utilizada', message:'A demo deste dispositivo j√° foi utilizada. Para continuar, adquira a vers√£o paga.' });
          return;
        }
        const start = await startDemoServer(deviceId, DEMO_DURATION_HOURS);
        console.log('startDemo server result:', start);
        if (start && start.ok && start.expiresAt){
          setDemoState(start.expiresAt, 'server');
          return;
        }
      }
    } catch (err){
      console.warn('Demo server endpoints indispon√≠veis, fallback local', err);
    }

    // fallback local (menos seguro)
    try {
      const localRaw = localStorage.getItem(DEMO_LOCAL_KEY);
      const local = localRaw ? JSON.parse(localRaw) : null;
      if (local && local.expiresAt){ setDemoState(local.expiresAt, 'local'); return; }
    } catch(e){}
    const now = Date.now();
    const expires = new Date(now + DEMO_DURATION_HOURS*3600*1000);
    try { localStorage.setItem(DEMO_LOCAL_KEY, JSON.stringify({ startedAt: new Date(now).toISOString(), expiresAt: expires.toISOString(), source: 'local' })); } catch(e){}
    setDemoState(expires.toISOString(), 'local');
  }

  /* ===== lock/unlock UI (igual ao seu c√≥digo) ===== */
  function lockApp(opts){
    demoLocked = true;
    if (document.getElementById('overlayLock')) return;
    const permanent = !!(opts && opts.permanent);
    const title = (opts && opts.title) ? opts.title : (permanent ? 'Acesso bloqueado' : 'Demo expirado');
    const msg = (opts && opts.message) ? opts.message : (permanent ? 'A demo j√° foi utilizada neste dispositivo.' : `Sua sess√£o demo expirou e o aplicativo foi bloqueado.`);
    const overlay = document.createElement('div'); overlay.id = 'overlayLock'; overlay.className = 'overlay-lock';
    const card = document.createElement('div'); card.className='overlay-card';
    card.innerHTML = `<h2>${title}</h2><p>${msg}</p><div style="display:flex;gap:8px;justify-content:center"><a class="linkbtn" href="${PURCHASE_URL}" target="_blank" rel="noopener noreferrer">Acessar vers√£o paga</a></div>`;
    overlay.appendChild(card);
    document.body.appendChild(overlay);
    document.getElementById('appRoot')?.style && (document.getElementById('appRoot').style.filter = 'blur(1px)');
    document.querySelectorAll('button,select').forEach(el => el.disabled = true);
  }

  function unlockAppClientSide(){
    localStorage.removeItem(DEMO_LOCAL_KEY);
    localStorage.removeItem(DEVICE_ID_KEY);
    if (document.getElementById('overlayLock')) document.getElementById('overlayLock').remove();
    document.getElementById('appRoot')?.style && (document.getElementById('appRoot').style.filter = '');
    document.querySelectorAll('button,select').forEach(el => el.disabled = false);
    demoLocked = false;
    checkAndStartDemo();
  }
  window.__unlockDemoForDev = unlockAppClientSide;

  /* ===== resto do seu app: renderStudies, quiz, cards, init etc. (mantidos iguais) ===== */
  async function renderStudies(){ if (isDemoLocked()) return; const container = document.getElementById('studyList'); if (!container) return; container.innerHTML = ''; try { const res = await fetch(`${SCRIPT_URL}?action=getStudies`, { cache:'no-store' }); const js = await res.json(); if (js && js.ok && js.studies && Array.isArray(js.studies) && js.studies.length){ js.studies.forEach((s,i)=>{ const d = document.createElement('details'); d.className='summary'; const sum = document.createElement('summary'); sum.innerText = (s.topico || s.topic || `T√≥pico ${i+1}`); d.appendChild(sum); const div = document.createElement('div'); div.style.padding = '8px 6px'; div.style.color = '#dfeff5'; div.innerHTML = linkify(s.conteudo || s.texto || s.conteudo || s.content || ''); d.appendChild(div); container.appendChild(d); }); return; } } catch(e){ console.warn('Erro ao buscar estudos', e); } if (!TEMPLATE_STUDIES || !Array.isArray(TEMPLATE_STUDIES) || TEMPLATE_STUDIES.length === 0){ container.innerHTML = '<div class="small">Nenhum conte√∫do de estudo (adicione aba "Estudos" com colunas: T√≥pico | Conte√∫do).</div>'; return; } TEMPLATE_STUDIES.forEach((s,i)=>{ const d = document.createElement('details'); d.className='summary'; const sum = document.createElement('summary'); sum.innerText = s.topico || s.title || `T√≥pico ${i+1}`; d.appendChild(sum); const div = document.createElement('div'); div.style.padding = '8px 6px'; div.style.color = '#dfeff5'; div.innerHTML = linkify(s.conteudo || s.content || ''); d.appendChild(div); container.appendChild(d); }); }

  const quizSizeLabel = document.getElementById('quizSizeLabel');
  quizSizeLabel.innerText = TEMPLATE_QUIZ_SIZE || 20;
  const topicSelect = document.getElementById('topicSelect');
  const loadTopicBtn = document.getElementById('loadTopicBtn');
  const nextBtn = document.getElementById('nextBtn');
  const optsDiv = document.getElementById('opts');
  const qEl = document.getElementById('question');
  const explainEl = document.getElementById('explain');
  const progressBar = document.getElementById('bar');
  const progressInfo = document.getElementById('progressInfo');
  const progressText = document.getElementById('progressText');
  const btnRestart = document.getElementById('btnRestart');

  loadTopicBtn.addEventListener('click', ()=> { if (isDemoLocked()) return; loadTopicQuestions(topicSelect.value); });
  nextBtn.addEventListener('click', ()=> { if (!quizStarted || isDemoLocked()) return; currentIndex++; renderQuestion(); });

  async function showTopicSelection(){ populateTopicSelect(['Todos']); try { const res = await fetch(`${SCRIPT_URL}?action=getTopics`, {cache:'no-store'}); const js = await res.json(); if (js && js.ok && js.topics) { populateTopicSelect(js.topics || []); return; } else { console.warn('getTopics returned no topics', js); } } catch (e) { console.warn('Erro fetch topics', e); } }
  function populateTopicSelect(topics){ topicSelect.innerHTML = ''; const optAll = document.createElement('option'); optAll.value='Todos'; optAll.textContent='Todos'; topicSelect.appendChild(optAll); if (topics && topics.length){ topics.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; topicSelect.appendChild(o); }); } }

  async function loadTopicQuestions(topic){
    qEl.innerText = 'Carregando perguntas...';
    try {
      const encoded = encodeURIComponent(topic || 'Todos');
      const res = await fetch(`${SCRIPT_URL}?action=getQuestionsByTopic&topic=${encoded}`, {cache:'no-store'});
      const js = await res.json();
      let data = (js && js.ok && js.questions) ? js.questions.slice() : [];
      if (!data.length && TEMPLATE_QUESTIONS && TEMPLATE_QUESTIONS.length){ data = TEMPLATE_QUESTIONS.slice(0, TEMPLATE_QUIZ_SIZE); }
      POOL = data.slice(0, TEMPLATE_QUIZ_SIZE);
      currentIndex = 0; score = 0; errors = []; quizStarted = true;
      btnRestart.style.display = 'none';
      renderQuestion();
    } catch (err){ console.error('Erro ao carregar quest√µes:', err); qEl.innerText = 'Erro ao carregar quest√µes. Verifique a conex√£o.'; }
  }

  function renderQuestion(){
    explainEl.style.display = 'none';
    nextBtn.disabled = true;
    if (!POOL || POOL.length === 0) {
      qEl.innerText = 'Nenhuma quest√£o dispon√≠vel. Carregue outro t√≥pico ou verifique a planilha.';
      optsDiv.innerHTML = '';
      progressBar.style.width = '0%';
      progressInfo.innerText = '0 / 0';
      progressText.innerText = '';
      btnRestart.style.display = 'inline-block';
      quizStarted = false;
      return;
    }
    if (currentIndex >= POOL.length) { finishQuiz(); return; }
    const q = POOL[currentIndex];
    qEl.style.opacity = 0;
    setTimeout(()=>{ qEl.innerText = `üìò ${q_topic(q) || ''}\n${q_text(q)}`; qEl.style.opacity = 1; }, 120);

    optsDiv.innerHTML = '';
    ['A','B','C','D'].forEach(letter => {
      const txt = q_option(q, letter);
      if (!txt) return;
      const btn = document.createElement('button');
      btn.className = 'opt';
      btn.id = 'opt_' + letter;
      btn.innerText = `${letter}) ${txt}`;
      btn.onclick = ()=> selectOption(letter);
      optsDiv.appendChild(btn);
    });

    updateProgressUI();
  }

  function selectOption(letter){
    if (!quizStarted || isDemoLocked()) return;
    const q = POOL[currentIndex];
    const correct = q_answer_letter(q);
    const chosen = letter.toUpperCase();
    document.querySelectorAll('.opt').forEach(el => el.disabled = true);
    if (correct) {
      const elCorrect = document.getElementById('opt_' + correct);
      if (elCorrect) elCorrect.classList.add('correct');
    }
    const elChosen = document.getElementById('opt_' + chosen);
    if (elChosen) {
      if (chosen === correct) { elChosen.classList.add('correct'); playCorrect(); score++; }
      else { elChosen.classList.add('wrong'); playWrong(); errors.push(q); }
    } else { if (chosen !== correct) { playWrong(); errors.push(q); } else playCorrect(); }
    const title = (chosen === correct) ? '‚úÖ Correto!' : ('‚ùå Errado! Resposta: ' + (correct || '‚Äî'));
    showExplanation(title, q_expl(q));
    nextBtn.disabled = false;
  }

  function showExplanation(title, explanation){ explainEl.style.display = 'block'; explainEl.innerHTML = `<strong>${title}</strong><div style="margin-top:8px;color:#dfeff5">${explanation || ''}</div>`; }
  function updateProgressUI(){ const total = POOL.length || 0; const pct = total ? Math.round((currentIndex / total) * 100) : 0; progressBar.style.width = pct + '%'; progressInfo.innerText = `${currentIndex + 1} / ${total}`; progressText.innerText = `Pontos: ${score}`; }
  function finishQuiz(){ quizStarted = false; const total = POOL.length || 1; const pct = Math.round((score / total) * 100); const badge = pct >= 80 ? 'üèÜ' : pct >= 60 ? 'üéâ' : pct >= 40 ? 'üëç' : 'üìò'; const finalTitle = `${badge} Voc√™ acertou ${score} de ${total} (${pct}%)`; qEl.innerText = finalTitle; optsDiv.innerHTML = ''; explainEl.style.display = 'block'; const rec = saveRecord(score, total); explainEl.innerHTML = `<div style="color:#dfeff5">${rec && rec.isNew ? 'üéØ Novo recorde! ' : ''}${rec && rec.record ? 'Seu recorde: ' + rec.record.score + '/' + rec.record.total + ' ('+rec.record.pct+'%)' : ''}</div>`; btnRestart.style.display = 'inline-block'; progressBar.style.width = '100%'; }
  function restartQuiz(){ if (topicSelect && topicSelect.value) loadTopicQuestions(topicSelect.value); else loadTopicQuestions('Todos'); }

  function saveRecord(score, total){ try { const pct = Math.round((score/total)*100); const now = new Date().toISOString(); const current = {score: score, total: total, pct: pct, when: now}; const prev = JSON.parse(localStorage.getItem(BEST_KEY) || 'null'); if (!prev || pct > prev.pct) { localStorage.setItem(BEST_KEY, JSON.stringify(current)); return {isNew:true, record: current, prev: prev}; } else { return {isNew:false, record: prev}; } } catch(e){ return null; } }
  function getRecord(){ try { return JSON.parse(localStorage.getItem(BEST_KEY) || 'null'); } catch(e){ return null; } }
  function showBestRecord(){ const rec = getRecord(); const el = document.getElementById('bestRecord'); if (!rec) el.innerText = 'Ainda sem recorde. Fa√ßa um quiz e apare√ßa aqui!'; else el.innerText = `Seu recorde: ${rec.score}/${rec.total} (${rec.pct}%) ‚Äî em ${new Date(rec.when).toLocaleString()}`; }

  // renderCards / makeCards omitted here to keep resposta curta ‚Äî use o bloco igual ao seu index original
  async function renderCards(){ /* ... mesmo que antes ... */ 
    const container = document.getElementById('cardsContainer');
    container.innerHTML = '';
    // (mantive seu c√≥digo de fetch e makeCards exatamente igual ao original ‚Äî cole aqui o trecho se quiser)
  }

  /* ===== inicializa√ß√£o ===== */
  (function init(){
    const cssScale = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--card-scale')) || 1.10;
    if (localStorage.getItem(SCALE_KEY) === null) localStorage.setItem(SCALE_KEY, cssScale.toFixed(2));
    if (window.innerWidth <= 520) localStorage.setItem(SCALE_KEY, '1.10');
    setScale(readSavedScale());

    checkAndStartDemo();
    renderStudies();
    showTopicSelection();
    showBestRecord();
    window.addEventListener('click', function unlock(){ try{ ensureAudio(); }catch(e){} window.removeEventListener('click', unlock); }, { once:true });
    document.getElementById('quizSizeLabel').innerText = TEMPLATE_QUIZ_SIZE || 20;
    document.getElementById('buyBtn').addEventListener('click', ()=> { window.open(PURCHASE_URL, '_blank', 'noopener'); });
    window.__unlockDemoForDev = unlockAppClientSide;
  })();

</script>
</body>
</html>
