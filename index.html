/***********************
 Code.gs — Server API
 Controle de demo por Fingerprint + User-Agent
 SOLUÇÃO 2 (MITIGAÇÃO FORTE)
***********************/

/* ===== CONFIG ===== */
const SCRIPT_PROPS = PropertiesService.getScriptProperties();
const API_KEY = SCRIPT_PROPS.getProperty('API_KEY') || '';

const SPREADSHEET_ID = '18eyeKiRJpSYDOWIqc4SVvKJ51Ozn7mWGzMQtU1H1f4I';
const DEMO_SHEET_NAME = 'DemoControl';
const DEMO_HOURS = 24;
const RATE_LIMIT_SECONDS = 2;

/* ===== UTIL ===== */
function _openSS(){
  return SpreadsheetApp.openById(SPREADSHEET_ID);
}

function _json(obj){
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function _sanitize(v, max){
  if(!v) return '';
  v = String(v).replace(/<[^>]*>/g,'').trim();
  return max ? v.substring(0, max) : v;
}

function _sha256(value){
  const raw = Utilities.computeDigest(
    Utilities.DigestAlgorithm.SHA_256,
    String(value)
  );
  return raw
    .map(b => (b + 256) % 256)
    .map(b => b.toString(16).padStart(2,'0'))
    .join('');
}

/* ===== SHEET ===== */
function _ensureSheet(){
  const ss = _openSS();
  let sh = ss.getSheetByName(DEMO_SHEET_NAME);
  if(!sh){
    sh = ss.insertSheet(DEMO_SHEET_NAME);
    sh.appendRow([
      'deviceId',
      'createdAt',
      'expiresAt',
      'fpHash',
      'uaHash',
      'note'
    ]);
  }
  return sh;
}

/* ===== RATE LIMIT ===== */
function _rateLimit(key){
  const props = PropertiesService.getScriptProperties();
  const last = Number(props.getProperty(key) || 0);
  const now = Date.now();

  if(now - last < RATE_LIMIT_SECONDS * 1000){
    throw 'RATE_LIMIT';
  }

  props.setProperty(key, String(now));
}

/* ===== SEARCH ===== */
function _findAny(fpHash, uaHash){
  const sh = _ensureSheet();
  const rows = sh.getDataRange().getValues();

  for(let i = rows.length - 1; i > 0; i--){
    if(rows[i][3] === fpHash || rows[i][4] === uaHash){
      return {
        row: rows[i],
        expired: new Date(rows[i][2]) < new Date()
      };
    }
  }
  return null;
}

/* ===== API ===== */
function doGet(e){
  try{
    if(API_KEY && e.parameter.apiKey !== API_KEY){
      throw 'INVALID_API_KEY';
    }

    const action = _sanitize(e.parameter.action, 40);

    /* === CHECK DEMO === */
    if(action === 'checkDemo'){
      const fp = _sanitize(e.parameter.fp, 400);
      const ua = _sanitize(e.parameter.ua, 800);

      if(!fp && !ua){
        return _json({ ok:false, error:'fp_or_ua_required' });
      }

      const match = _findAny(
        _sha256(fp),
        _sha256(ua)
      );

      if(match){
        return _json({
          ok: true,
          active: !match.expired,
          used: true,
          expiresAt: match.row[2]
        });
      }

      return _json({
        ok: true,
        active: false,
        used: false
      });
    }

    /* === START DEMO === */
    if(action === 'startDemo'){
      const fp = _sanitize(e.parameter.fp, 400);
      const ua = _sanitize(e.parameter.ua, 800);
      const deviceId = _sanitize(e.parameter.deviceId, 120);

      if(!fp && !ua){
        return _json({ ok:false, error:'fp_or_ua_required' });
      }

      const fpHash = _sha256(fp);
      const uaHash = _sha256(ua);

      _rateLimit(_sha256(fpHash + uaHash));

      const exists = _findAny(fpHash, uaHash);
      if(exists){
        return _json({
          ok: true,
          active: false,
          used: true,
          note: 'fingerprint_already_used'
        });
      }

      const sh = _ensureSheet();
      const now = new Date();
      const expires = new Date(
        now.getTime() + DEMO_HOURS * 3600 * 1000
      );

      sh.appendRow([
        deviceId || '',
        now.toISOString(),
        expires.toISOString(),
        fpHash,
        uaHash,
        'demo_started'
      ]);

      return _json({
        ok: true,
        active: true,
        expiresAt: expires.toISOString()
      });
    }

    return _json({ ok:false, error:'unknown_action' });

  }catch(err){
    return _json({
      ok:false,
      error:String(err)
    });
  }
}
