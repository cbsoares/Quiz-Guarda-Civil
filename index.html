<script>
/* ===================== CONFIGURE AQUI ===================== */
/* Cole a URL do seu Web App (Apps Script) aqui ‚Äî deve terminar em /exec */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0N7QaZhaoM5o3qgye8ZINbHAKcwLI7GgPvaQioxdBhjrz-UlNGYNKW82CNhUBZzIWpQ/exec';
const QUIZ_SIZE = 20; // quantas quest√µes por rodada (padr√£o)
/* ========================================================= */

function safeLog(){ if(window.console) console.log.apply(console, arguments); }

// helpers para compatibilidade com o HTML antigo
function q_text(q){ return q.pergunta || q.question || q.Pergunta || q.Question || ''; }
function q_topic(q){ return q.materia || q.Mat√©ria || q.topic || ''; }
function q_expl(q){ return q.explicacao || q.explanation || q.Explicacao || ''; }
function q_answer_letter(q){ const a = (q.resposta || q.answer || q.Resposta || q.Answer || '').toString().trim(); return a ? a.substr(0,1).toUpperCase() : ''; }
function q_option(q, letter){ const up = q[letter.toUpperCase()]; if (up !== undefined && up !== null && up !== '') return up; const low = q[letter.toLowerCase()]; if (low !== undefined && low !== null && low !== '') return low; return ''; }

async function apiFetch(action, params = {}){
if (!SCRIPT_URL || SCRIPT_URL.indexOf('REPLACE_WITH') !== -1) {
return { ok:false, error: 'SCRIPT_URL not set. Edit index.html and set your Web App URL.' };
}
const url = new URL(SCRIPT_URL);
url.searchParams.set('action', action);
Object.keys(params).forEach(k => url.searchParams.set(k, params[k]));
try {
const r = await fetch(url.toString(), { cache: 'no-store' });
const j = await r.json();
return j;
} catch(e){
return { ok:false, error: String(e) };
}
}

/* DOM refs */
const topicSelect = document.getElementById('topicSelect');
const loadTopicBtn = document.getElementById('loadTopicBtn');
const nextBtn = document.getElementById('nextBtn');
const optsDiv = document.getElementById('opts');
const qEl = document.getElementById('question');
const explainEl = document.getElementById('explain');
const progressBar = document.getElementById('bar');
const progressInfo = document.getElementById('progressInfo');
const progressText = document.getElementById('progressText');
const btnRestart = document.getElementById('btnRestart');

let POOL = [], currentIndex = 0, score = 0, quizStarted = false;

loadTopicBtn.addEventListener('click', ()=> loadTopicQuestions(topicSelect.value));
nextBtn.addEventListener('click', ()=> { if(!quizStarted) return; currentIndex++; renderQuestion(); });
btnRestart.addEventListener('click', ()=> restartQuiz());

function go(target){
document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
document.getElementById(target).classList.add('active');
document.querySelectorAll('.tabbtn').forEach(b => b.classList.toggle('active', b.dataset.target === target));
if (target === 'study') renderStudies();
if (target === 'cards') renderCards();
if (target === 'quiz') if (!quizStarted) showTopicSelection();
}

async function showTopicSelection(){
const res = await apiFetch('getTopics');
const topics = (res && res.topics) ? res.topics : [];
populateTopicSelect(topics);
}

function populateTopicSelect(topics){
topicSelect.innerHTML = '';
const optAll = document.createElement('option'); optAll.value='Todos'; optAll.textContent='Todos'; topicSelect.appendChild(optAll);
(topics || []).forEach(t => {
const o = document.createElement('option'); o.value = t; o.textContent = t; topicSelect.appendChild(o);
});
}

async function loadTopicQuestions(topic){
qEl.innerText = 'Carregando perguntas...';
const res = await apiFetch('getQuestionsByTopic', { topic: topic || 'Todos' });
let data = (res && res.questions) ? res.questions : [];
// fallback para getAllQuestions caso o endpoint n√£o retorne
if (!data.length) {
const res2 = await apiFetch('getAllQuestions');
data = (res2 && res2.questions) ? res2.questions : [];
}
// shuffle e cortar para QUIZ_SIZE
for (let i=data.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [data[i],data[j]]=[data[j],data[i]]; }
POOL = data.slice(0, QUIZ_SIZE || 20);
currentIndex = 0; score = 0; quizStarted = true; btnRestart.style.display = 'none';
renderQuestion();
}

function renderQuestion(){
explainEl.style.display = 'none';
nextBtn.disabled = true;
if (!POOL || POOL.length === 0){ qEl.innerText='Nenhuma quest√£o dispon√≠vel.'; optsDiv.innerHTML=''; progressBar.style.width='0%'; progressInfo.innerText='0 / 0'; return; }
if (currentIndex >= POOL.length){ finishQuiz(); return; }
const q = POOL[currentIndex];
qEl.innerText = `üìò ${q_topic(q) || ''}\n${q_text(q)}`;
optsDiv.innerHTML = '';
['A','B','C','D'].forEach(letter=>{
const txt = q_option(q, letter);
if (!txt) return;
const btn = document.createElement('button'); btn.className='opt'; btn.id='opt_'+letter; btn.innerText=`${letter}) ${txt}`; btn.onclick = ()=> selectOption(letter);
optsDiv.appendChild(btn);
});
updateProgressUI();
}

function selectOption(letter){
if (!quizStarted) return;
const q = POOL[currentIndex];
const correct = q_answer_letter(q);
const chosen = letter.toUpperCase();
document.querySelectorAll('.opt').forEach(el => el.disabled = true);
if (correct){
const elc = document.getElementById('opt_'+correct); if (elc) elc.classList.add('correct');
}
const elChosen = document.getElementById('opt_'+chosen);
if (elChosen){
if (chosen === correct){ elChosen.classList.add('correct'); score++; }
else { elChosen.classList.add('wrong'); }
}
const title = (chosen === correct) ? '‚úÖ Correto!' : ('‚ùå Errado! Resposta: ' + (correct || '‚Äî'));
showExplanation(title, q_expl(q));
nextBtn.disabled = false;
}

function showExplanation(title, explanation){ explainEl.style.display='block'; explainEl.innerHTML = `<strong>${title}</strong><div style="margin-top:8px;color:#dfeff5">${explanation||''}</div>`; }

function updateProgressUI(){ const total = POOL.length || 0; const pct = total ? Math.round((currentIndex/total)*100) : 0; progressBar.style.width = pct + '%'; progressInfo.innerText = `${currentIndex+1} / ${total}`; progressText.innerText = `Pontos: ${score}`; }

function finishQuiz(){ quizStarted=false; const total=POOL.length||1; const pct=Math.round((score/total)*100); qEl.innerText = `Voc√™ acertou ${score} de ${total} (${pct}%)`; optsDiv.innerHTML=''; explainEl.style.display='block'; btnRestart.style.display='inline-block'; progressBar.style.width='100%'; }

function restartQuiz(){ if (topicSelect && topicSelect.value) loadTopicQuestions(topicSelect.value); else loadTopicQuestions('Todos'); }

async function renderStudies(){
const container = document.getElementById('studyList'); container.innerHTML='';
const res = await apiFetch('getStudies');
const list = (res && res.studies) ? res.studies : [];
if (!list.length) { container.innerHTML='<div class="small">Nenhum conte√∫do de estudo.</div>'; return; }
list.forEach((s,i)=>{ const d=document.createElement('details'); d.className='summary'; const sum=document.createElement('summary'); sum.innerText = s.topico || `T√≥pico ${i+1}`; d.appendChild(sum); const div=document.createElement('div'); div.style.padding='8px 6px'; div.style.color='#dfeff5'; div.innerHTML=(s.conteudo||'').toString().replace(/\n/g,'<br>'); d.appendChild(div); container.appendChild(d); });
}

async function renderCards(){
const container = document.getElementById('cardsContainer'); container.innerHTML='';
const res = await apiFetch('getAllQuestions');
const list = (res && res.questions) ? res.questions : [];
if (!list.length){ container.innerHTML='<div class="small">Nenhum cart√£o dispon√≠vel.</div>'; return; }
for (let i=list.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [list[i],list[j]]=[list[j],list[i]]; }
list.forEach(q=>{ const wrapper=document.createElement('div'); wrapper.className='flashcard card-small'; const inner=document.createElement('div'); inner.className='flash-inner'; const front=document.createElement('div'); front.className='flash-front'; const back=document.createElement('div'); back.className='flash-back'; front.innerHTML=`<div style="font-size:12px;color:#dfeff5">${q_topic(q)||''}</div><div style="font-weight:800;margin-top:8px">${q_text(q)}</div><div style="margin-top:8px;font-size:13px;color:#bfeadf">Clique para ver explica√ß√£o</div>`; back.innerHTML=`<div style="font-size:12px;color:#dfeff5">${q_topic(q)||''}</div><div style="font-weight:800;margin-top:8px">Resposta: ${q_answer_letter(q)||'‚Äî'}</div><div style="margin-top:8px;color:#dfeff5">${q_expl(q)||''}</div>`; inner.appendChild(front); inner.appendChild(back); wrapper.appendChild(inner); wrapper.addEventListener('click', ()=> inner.classList.toggle('flipped')); container.appendChild(wrapper); });
}

/* local record */
function saveRecordObj(score,total){ try{ const pct=Math.round((score/total)*100); const now=new Date().toISOString(); const cur={score,total,pct,when:now}; const prev=JSON.parse(localStorage.getItem('quiz_best_record')||'null'); if(!prev||pct>prev.pct){ localStorage.setItem('quiz_best_record', JSON.stringify(cur)); return {isNew:true, record: cur}; } return {isNew:false, record: prev}; }catch(e){return null;} }
function getRecordObj(){ try{return JSON.parse(localStorage.getItem('quiz_best_record')||'null');}catch(e){return null;} }
function showBestRecord(){ const r=getRecordObj(); const el=document.getElementById('bestRecord'); if(!r) el.innerText='Ainda sem recorde.'; else el.innerText=`Seu recorde: ${r.score}/${r.total} (${r.pct}%) ‚Äî em ${new Date(r.when).toLocaleString()}`; }

/* init */
(function init(){ document.getElementById('quizSizeLabel').innerText = QUIZ_SIZE; showTopicSelection(); renderStudies(); showBestRecord(); })();
</script>
</body>
</html>
